{"version":3,"file":"index.js","names":["React","isImage","DraggableSortableItem","DraggableSortable","DragHandleIcon","getBestFitFromSizes","RelationshipContent","UploadCard","baseClass","UploadComponentHasMany","props","className","displayPreview","fileDocs","isSortable","onRemove","onReorder","readonly","reloadDoc","serverURL","moveRow","useCallback","moveFromIndex","moveToIndex","updatedArray","item","splice","removeItem","index","length","_jsx","filter","Boolean","join","ids","map","value","String","id","onDragEnd","relationTo","src","thumbnailSrc","url","URL","toString","thumbnailURL","mimeType","sizes","width","disabled","draggableSortableItemProps","ref","setNodeRef","style","transform","transition","zIndex","isDragging","undefined","_jsxs","size","attributes","listeners","allowEdit","allowRemove","alt","filename","byteSize","filesize","collectionSlug","withMeta","x","y","height"],"sources":["../../../../src/fields/Upload/HasMany/index.tsx"],"sourcesContent":["\"use client\";\n\nimport \"./index.scss\";\n\nimport type { JsonObject } from \"@convexcms/core\";\nimport React from \"react\";\nimport { isImage } from \"@convexcms/core/shared\";\n\nimport type { ReloadDoc } from \"../types.js\";\nimport { DraggableSortableItem } from \"../../../elements/DraggableSortable/DraggableSortableItem/index.js\";\nimport { DraggableSortable } from \"../../../elements/DraggableSortable/index.js\";\nimport { DragHandleIcon } from \"../../../icons/DragHandle/index.js\";\nimport { getBestFitFromSizes } from \"../../../utilities/getBestFitFromSizes.js\";\nimport { RelationshipContent } from \"../RelationshipContent/index.js\";\nimport { UploadCard } from \"../UploadCard/index.js\";\n\nconst baseClass = \"upload upload--has-many\";\n\ntype Props = {\n  readonly className?: string;\n  readonly displayPreview?: boolean;\n  readonly fileDocs: {\n    relationTo: string;\n    value: JsonObject;\n  }[];\n  readonly isSortable?: boolean;\n  readonly onRemove?: (value) => void;\n  readonly onReorder?: (value) => void;\n  readonly readonly?: boolean;\n  readonly reloadDoc: ReloadDoc;\n  readonly serverURL: string;\n};\n\nexport function UploadComponentHasMany(props: Props) {\n  const {\n    className,\n    displayPreview,\n    fileDocs,\n    isSortable,\n    onRemove,\n    onReorder,\n    readonly,\n    reloadDoc,\n    serverURL,\n  } = props;\n\n  const moveRow = React.useCallback(\n    (moveFromIndex: number, moveToIndex: number) => {\n      if (moveFromIndex === moveToIndex) {\n        return;\n      }\n\n      const updatedArray = [...fileDocs];\n      const [item] = updatedArray.splice(moveFromIndex, 1);\n\n      updatedArray.splice(moveToIndex, 0, item);\n\n      onReorder(updatedArray);\n    },\n    [fileDocs, onReorder],\n  );\n\n  const removeItem = React.useCallback(\n    (index: number) => {\n      const updatedArray = [...(fileDocs || [])];\n      updatedArray.splice(index, 1);\n      onRemove(updatedArray.length === 0 ? [] : updatedArray);\n    },\n    [fileDocs, onRemove],\n  );\n\n  return (\n    <div className={[baseClass, className].filter(Boolean).join(\" \")}>\n      <DraggableSortable\n        className={`${baseClass}__draggable-rows`}\n        ids={fileDocs?.map(({ value }) => String(value.id))}\n        onDragEnd={({ moveFromIndex, moveToIndex }) =>\n          moveRow(moveFromIndex, moveToIndex)\n        }\n      >\n        {fileDocs.map(({ relationTo, value }, index) => {\n          const id = String(value.id);\n          let src: string;\n          let thumbnailSrc: string;\n\n          if (value.url) {\n            try {\n              src = new URL(value.url, serverURL).toString();\n            } catch {\n              src = `${serverURL}${value.url}`;\n            }\n          }\n\n          if (value.thumbnailURL) {\n            try {\n              thumbnailSrc = new URL(value.thumbnailURL, serverURL).toString();\n            } catch {\n              thumbnailSrc = `${serverURL}${value.thumbnailURL}`;\n            }\n          }\n\n          if (isImage(value.mimeType)) {\n            thumbnailSrc = getBestFitFromSizes({\n              sizes: value.sizes,\n              thumbnailURL: thumbnailSrc,\n              url: src,\n              width: value.width,\n            });\n          }\n\n          return (\n            <DraggableSortableItem\n              disabled={!isSortable || readonly}\n              id={id}\n              key={id}\n            >\n              {(draggableSortableItemProps) => (\n                <div\n                  className={[\n                    `${baseClass}__dragItem`,\n                    draggableSortableItemProps &&\n                      isSortable &&\n                      `${baseClass}--has-drag-handle`,\n                  ]\n                    .filter(Boolean)\n                    .join(\" \")}\n                  ref={draggableSortableItemProps.setNodeRef}\n                  style={{\n                    transform: draggableSortableItemProps.transform,\n                    transition: draggableSortableItemProps.transition,\n                    zIndex: draggableSortableItemProps.isDragging\n                      ? 1\n                      : undefined,\n                  }}\n                >\n                  <UploadCard size=\"small\">\n                    {draggableSortableItemProps && (\n                      <div\n                        className={`${baseClass}__drag`}\n                        {...draggableSortableItemProps.attributes}\n                        {...draggableSortableItemProps.listeners}\n                      >\n                        <DragHandleIcon />\n                      </div>\n                    )}\n\n                    <RelationshipContent\n                      allowEdit={!readonly}\n                      allowRemove={!readonly}\n                      alt={(value?.alt || value?.filename) as string}\n                      byteSize={value.filesize as number}\n                      collectionSlug={relationTo}\n                      displayPreview={displayPreview}\n                      filename={value.filename as string}\n                      id={id}\n                      mimeType={value?.mimeType as string}\n                      onRemove={() => removeItem(index)}\n                      reloadDoc={reloadDoc}\n                      src={src}\n                      thumbnailSrc={thumbnailSrc}\n                      withMeta={false}\n                      x={value?.width as number}\n                      y={value?.height as number}\n                    />\n                  </UploadCard>\n                </div>\n              )}\n            </DraggableSortableItem>\n          );\n        })}\n      </DraggableSortable>\n    </div>\n  );\n}\n"],"mappings":"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","ignoreList":[]}