{"version":3,"file":"index.js","names":["React","createContext","use","useCallback","useEffect","useReducer","useRef","useDebounce","useConfig","useLocale","useTranslation","reducer","Context","RelationshipProvider","children","documents","dispatchDocuments","debouncedDocuments","config","routes","api","serverURL","i18n","code","locale","prevLocale","loadRelationshipDocs","reloadAll","Object","entries","forEach","slug","docs","idsToLoad","id","value","push","length","url","params","URLSearchParams","append","idsToString","map","String","join","query","toString","result","fetch","credentials","headers","language","ok","json","type","relationTo","current","getRelationships","relationships","_jsx","useListRelationships"],"sources":["../../../../src/elements/Table/RelationshipProvider/index.tsx"],"sourcesContent":["\"use client\";\n\nimport type { TypeWithID } from \"@convexcms/core\";\nimport React, {\n  createContext,\n  use,\n  useCallback,\n  useEffect,\n  useReducer,\n  useRef,\n} from \"react\";\n\nimport { useDebounce } from \"../../../hooks/useDebounce.js\";\nimport { useConfig } from \"../../../providers/Config/index.js\";\nimport { useLocale } from \"../../../providers/Locale/index.js\";\nimport { useTranslation } from \"../../../providers/Translation/index.js\";\nimport { reducer } from \"./reducer.js\";\n\n// documents are first set to null when requested\n// set to false when no doc is returned\n// or set to the document returned\nexport type Documents = {\n  [slug: string]: {\n    [id: number | string]: false | null | TypeWithID;\n  };\n};\n\ntype ListRelationshipContext = {\n  documents: Documents;\n  getRelationships: (\n    docs: {\n      relationTo: string;\n      value: number | string;\n    }[],\n  ) => void;\n};\n\nconst Context = createContext({} as ListRelationshipContext);\n\nexport const RelationshipProvider: React.FC<{\n  readonly children?: React.ReactNode;\n}> = ({ children }) => {\n  const [documents, dispatchDocuments] = useReducer(reducer, {});\n  const debouncedDocuments = useDebounce(documents, 100);\n\n  const {\n    config: {\n      routes: { api },\n      serverURL,\n    },\n  } = useConfig();\n\n  const { i18n } = useTranslation();\n  const { code: locale } = useLocale();\n  const prevLocale = useRef(locale);\n\n  const loadRelationshipDocs = useCallback(\n    (reloadAll = false) => {\n      Object.entries(debouncedDocuments).forEach(async ([slug, docs]) => {\n        const idsToLoad: (number | string)[] = [];\n\n        Object.entries(docs).forEach(([id, value]) => {\n          if (value === null || reloadAll) {\n            idsToLoad.push(id);\n          }\n        });\n\n        if (idsToLoad.length > 0) {\n          const url = `${serverURL}${api}/${slug}`;\n\n          const params = new URLSearchParams();\n\n          params.append(\"depth\", \"0\");\n          params.append(\"limit\", \"250\");\n\n          if (locale) {\n            params.append(\"locale\", locale);\n          }\n\n          if (idsToLoad && idsToLoad.length > 0) {\n            const idsToString = idsToLoad.map((id) => String(id));\n            params.append(\"where[id][in]\", idsToString.join(\",\"));\n          }\n\n          const query = `?${params.toString()}`;\n\n          const result = await fetch(`${url}${query}`, {\n            credentials: \"include\",\n            headers: {\n              \"Accept-Language\": i18n.language,\n            },\n          });\n\n          if (result.ok) {\n            const json = await result.json();\n            if (json.docs) {\n              dispatchDocuments({\n                type: \"ADD_LOADED\",\n                docs: json.docs,\n                idsToLoad,\n                relationTo: slug,\n              });\n            }\n          } else {\n            dispatchDocuments({\n              type: \"ADD_LOADED\",\n              docs: [],\n              idsToLoad,\n              relationTo: slug,\n            });\n          }\n        }\n      });\n    },\n    [debouncedDocuments, serverURL, api, i18n, locale],\n  );\n\n  useEffect(() => {\n    void loadRelationshipDocs(locale && prevLocale.current !== locale);\n    prevLocale.current = locale;\n  }, [locale, loadRelationshipDocs]);\n\n  const getRelationships = useCallback(\n    (relationships: { relationTo: string; value: number | string }[]) => {\n      dispatchDocuments({ type: \"REQUEST\", docs: relationships });\n    },\n    [],\n  );\n\n  return <Context value={{ documents, getRelationships }}>{children}</Context>;\n};\n\nexport const useListRelationships = (): ListRelationshipContext => use(Context);\n"],"mappings":"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","ignoreList":[]}