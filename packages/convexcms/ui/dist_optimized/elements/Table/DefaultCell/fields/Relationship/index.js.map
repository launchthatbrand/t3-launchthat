{"version":3,"file":"index.js","names":["React","useEffect","useMemo","useState","getTranslation","useIntersect","useConfig","useTranslation","canUseDOM","formatDocTitle","useListRelationships","FileCell","baseClass","totalToShow","RelationshipCell","cellData","cellDataFromProps","customCellProps","customCellContext","field","label","relationTo","collection","docs","config","getEntityConfig","collections","routes","intersectionRef","entry","values","setValues","documents","getRelationships","hasRequested","setHasRequested","i18n","t","isAboveViewport","boundingClientRect","top","window","innerHeight","formattedValues","arrayCellData","Array","isArray","slice","length","forEach","cell","push","value","api","_jsxs","className","ref","map","i","document","relatedCollection","collectionSlug","collectionConfig","data","dateFormat","admin","fallback","fileField","type","fieldPreviewAllowed","displayPreview","undefined","previewAllowed","upload","_jsx","slug","rowData","Fragment","count","items"],"sources":["../../../../../../src/elements/Table/DefaultCell/fields/Relationship/index.tsx"],"sourcesContent":["\"use client\";\n\nimport \"./index.scss\";\n\nimport type {\n  DefaultCellComponentProps,\n  JoinFieldClient,\n  RelationshipFieldClient,\n  UploadFieldClient,\n} from \"@convexcms/core\";\nimport React, { useEffect, useMemo, useState } from \"react\";\nimport { getTranslation } from \"@convexcms/translations\";\n\nimport { useIntersect } from \"../../../../../hooks/useIntersect.js\";\nimport { useConfig } from \"../../../../../providers/Config/index.js\";\nimport { useTranslation } from \"../../../../../providers/Translation/index.js\";\nimport { canUseDOM } from \"../../../../../utilities/canUseDOM.js\";\nimport { formatDocTitle } from \"../../../../../utilities/formatDocTitle/index.js\";\nimport { useListRelationships } from \"../../../RelationshipProvider/index.js\";\nimport { FileCell } from \"../File/index.js\";\n\ntype Value = { relationTo: string; value: number | string };\nconst baseClass = \"relationship-cell\";\nconst totalToShow = 3;\n\nexport type RelationshipCellProps = DefaultCellComponentProps<\n  JoinFieldClient | RelationshipFieldClient | UploadFieldClient\n>;\n\nexport const RelationshipCell: React.FC<RelationshipCellProps> = ({\n  cellData: cellDataFromProps,\n  customCellProps: customCellContext,\n  field,\n  field: { label },\n}) => {\n  // conditionally extract relationTo both both relationship and join fields\n  const relationTo =\n    (\"relationTo\" in field && field.relationTo) ||\n    (\"collection\" in field && field.collection);\n\n  // conditionally extract docs from join fields\n  const cellData = useMemo(() => {\n    return \"collection\" in field ? cellDataFromProps?.docs : cellDataFromProps;\n  }, [cellDataFromProps, field]);\n\n  const { config, getEntityConfig } = useConfig();\n  const { collections, routes } = config;\n  const [intersectionRef, entry] = useIntersect();\n  const [values, setValues] = useState<Value[]>([]);\n  const { documents, getRelationships } = useListRelationships();\n  const [hasRequested, setHasRequested] = useState(false);\n  const { i18n, t } = useTranslation();\n\n  const isAboveViewport = canUseDOM\n    ? entry?.boundingClientRect?.top < window.innerHeight\n    : false;\n\n  useEffect(() => {\n    if (\n      (cellData || typeof cellData === \"number\") &&\n      isAboveViewport &&\n      !hasRequested\n    ) {\n      const formattedValues: Value[] = [];\n      const arrayCellData = Array.isArray(cellData) ? cellData : [cellData];\n      arrayCellData\n        .slice(\n          0,\n          arrayCellData.length < totalToShow\n            ? arrayCellData.length\n            : totalToShow,\n        )\n        .forEach((cell) => {\n          if (\n            typeof cell === \"object\" &&\n            \"relationTo\" in cell &&\n            \"value\" in cell\n          ) {\n            formattedValues.push(cell);\n          }\n          if (\n            (typeof cell === \"number\" || typeof cell === \"string\") &&\n            typeof relationTo === \"string\"\n          ) {\n            formattedValues.push({\n              relationTo,\n              value: cell,\n            });\n          }\n        });\n      getRelationships(formattedValues);\n      setHasRequested(true);\n      setValues(formattedValues);\n    }\n  }, [\n    cellData,\n    relationTo,\n    collections,\n    isAboveViewport,\n    routes.api,\n    hasRequested,\n    getRelationships,\n  ]);\n\n  useEffect(() => {\n    if (hasRequested) {\n      setHasRequested(false);\n    }\n  }, [cellData]);\n\n  return (\n    <div className={baseClass} ref={intersectionRef}>\n      {values.map(({ relationTo, value }, i) => {\n        const document = documents[relationTo][value];\n        const relatedCollection = getEntityConfig({\n          collectionSlug: relationTo,\n        });\n\n        const label = formatDocTitle({\n          collectionConfig: relatedCollection,\n          data: document || null,\n          dateFormat: config.admin.dateFormat,\n          fallback: `${t(\"general:untitled\")} - ID: ${value}`,\n          i18n,\n        });\n\n        let fileField = null;\n\n        if (field.type === \"upload\") {\n          const fieldPreviewAllowed =\n            \"displayPreview\" in field ? field.displayPreview : undefined;\n          const previewAllowed =\n            fieldPreviewAllowed ??\n            relatedCollection.upload?.displayPreview ??\n            true;\n\n          if (previewAllowed && document) {\n            fileField = (\n              <FileCell\n                cellData={label}\n                collectionConfig={relatedCollection}\n                collectionSlug={relatedCollection.slug}\n                customCellProps={customCellContext}\n                field={field}\n                rowData={document}\n              />\n            );\n          }\n        }\n\n        return (\n          <React.Fragment key={i}>\n            {document === false && `${t(\"general:untitled\")} - ID: ${value}`}\n            {document === null && `${t(\"general:loading\")}...`}\n            {document ? fileField || label : null}\n            {values.length > i + 1 && \", \"}\n          </React.Fragment>\n        );\n      })}\n      {Array.isArray(cellData) &&\n        cellData.length > totalToShow &&\n        t(\"fields:itemsAndMore\", {\n          count: cellData.length - totalToShow,\n          items: \"\",\n        })}\n      {values.length === 0 &&\n        t(\"general:noLabel\", { label: getTranslation(label || \"\", i18n) })}\n    </div>\n  );\n};\n"],"mappings":"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","ignoreList":[]}