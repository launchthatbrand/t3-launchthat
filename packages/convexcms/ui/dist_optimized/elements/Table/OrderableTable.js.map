{"version":3,"file":"OrderableTable.js","names":["React","useEffect","useState","DragOverlay","toast","useListQuery","DraggableSortableItem","DraggableSortable","OrderableRow","OrderableRowDragPreview","baseClass","OrderableTable","appearance","collection","columns","data","initialData","listQueryData","handleSortChange","orderableFieldName","query","serverData","docs","localData","setLocalData","cellMap","setCellMap","dragActiveRowId","setDragActiveRowId","Object","fromEntries","map","item","index","String","id","_id","activeColumns","filter","col","active","includes","accessor","length","_jsx","handleDragEnd","moveFromIndex","moveToIndex","sort","warning","undefined","movedId","newBeforeRow","newAfterRow","previousData","currentData","newData","splice","target","key","newKeyWillBe","jsonBody","collectionSlug","slug","docsToMove","response","fetch","body","JSON","stringify","headers","method","status","Error","ok","err","error","message","handleDragStart","rowIds","row","className","Boolean","join","_jsxs","ids","onDragEnd","onDragStart","cellPadding","cellSpacing","i","Heading","rowIndex","children","attributes","isDragging","listeners","setNodeRef","transform","transition","dragAttributes","dragListeners","ref","rowId","style","opacity"],"sources":["../../../src/elements/Table/OrderableTable.tsx"],"sourcesContent":["\"use client\";\n\nimport \"./index.scss\";\n\nimport type {\n  ClientCollectionConfig,\n  Column,\n  OrderableEndpointBody,\n} from \"@convexcms/core\";\nimport React, { useEffect, useState } from \"react\";\nimport { DragOverlay } from \"@dnd-kit/core\";\nimport { toast } from \"sonner\";\n\nimport { useListQuery } from \"../../providers/ListQuery/index.js\";\nimport { DraggableSortableItem } from \"../DraggableSortable/DraggableSortableItem/index.js\";\nimport { DraggableSortable } from \"../DraggableSortable/index.js\";\nimport { OrderableRow } from \"./OrderableRow.js\";\nimport { OrderableRowDragPreview } from \"./OrderableRowDragPreview.js\";\n\nconst baseClass = \"table\";\n\nexport type Props = {\n  readonly appearance?: \"condensed\" | \"default\";\n  readonly collection: ClientCollectionConfig;\n  readonly columns?: Column[];\n  readonly data: Record<string, unknown>[];\n};\n\nexport const OrderableTable: React.FC<Props> = ({\n  appearance = \"default\",\n  collection,\n  columns,\n  data: initialData,\n}) => {\n  const {\n    data: listQueryData,\n    handleSortChange,\n    orderableFieldName,\n    query,\n  } = useListQuery();\n  // Use the data from ListQueryProvider if available, otherwise use the props\n  const serverData = listQueryData?.docs || initialData;\n\n  // Local state to track the current order of rows\n  const [localData, setLocalData] = useState(serverData);\n\n  // id -> index for each column\n  const [cellMap, setCellMap] = useState<Record<string, number>>({});\n\n  const [dragActiveRowId, setDragActiveRowId] = useState<\n    number | string | undefined\n  >();\n\n  // Update local data when server data changes\n  useEffect(() => {\n    setLocalData(serverData);\n    setCellMap(\n      Object.fromEntries(\n        serverData.map((item, index) => [String(item.id ?? item._id), index]),\n      ),\n    );\n  }, [serverData]);\n\n  const activeColumns = columns?.filter((col) => col?.active);\n\n  if (\n    !activeColumns ||\n    activeColumns.filter(\n      (col) => ![\"_dragHandle\", \"_select\"].includes(col.accessor),\n    ).length === 0\n  ) {\n    return <div>No columns selected</div>;\n  }\n\n  const handleDragEnd = async ({ moveFromIndex, moveToIndex }) => {\n    if (\n      query.sort !== orderableFieldName &&\n      query.sort !== `-${orderableFieldName}`\n    ) {\n      toast.warning(\n        'To reorder the rows you must first sort them by the \"Order\" column',\n      );\n      setDragActiveRowId(undefined);\n      return;\n    }\n\n    if (moveFromIndex === moveToIndex) {\n      setDragActiveRowId(undefined);\n      return;\n    }\n\n    const movedId = localData[moveFromIndex].id ?? localData[moveFromIndex]._id;\n    const newBeforeRow =\n      moveToIndex > moveFromIndex\n        ? localData[moveToIndex]\n        : localData[moveToIndex - 1];\n    const newAfterRow =\n      moveToIndex > moveFromIndex\n        ? localData[moveToIndex + 1]\n        : localData[moveToIndex];\n\n    // Store the original data for rollback\n    const previousData = [...localData];\n\n    // Optimisitc update of local state to reorder the rows\n    setLocalData((currentData) => {\n      const newData = [...currentData];\n      // Update the rendered cell for the moved row to show \"pending\"\n      newData[moveFromIndex][orderableFieldName] = `pending`;\n      // Move the item in the array\n      newData.splice(moveToIndex, 0, newData.splice(moveFromIndex, 1)[0]);\n      return newData;\n    });\n\n    try {\n      const target: OrderableEndpointBody[\"target\"] = newBeforeRow\n        ? {\n            id: newBeforeRow.id ?? newBeforeRow._id,\n            key: newBeforeRow[orderableFieldName],\n          }\n        : {\n            id: newAfterRow.id ?? newAfterRow._id,\n            key: newAfterRow[orderableFieldName],\n          };\n\n      const newKeyWillBe =\n        (newBeforeRow && query.sort === orderableFieldName) ||\n        (!newBeforeRow && query.sort === `-${orderableFieldName}`)\n          ? \"greater\"\n          : \"less\";\n\n      const jsonBody: OrderableEndpointBody = {\n        collectionSlug: collection.slug,\n        docsToMove: [movedId],\n        newKeyWillBe,\n        orderableFieldName,\n        target,\n      };\n\n      const response = await fetch(`/api/reorder`, {\n        body: JSON.stringify(jsonBody),\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        method: \"POST\",\n      });\n\n      if (response.status === 403) {\n        throw new Error(\"You do not have permission to reorder these rows\");\n      }\n\n      if (!response.ok) {\n        throw new Error(\n          \"Failed to reorder. This can happen if you reorder several rows too quickly. Please try again.\",\n        );\n      }\n    } catch (err) {\n      const error = err instanceof Error ? err.message : String(err);\n      // Rollback to previous state if the request fails\n      setLocalData(previousData);\n      toast.error(error);\n    } finally {\n      setDragActiveRowId(undefined);\n    }\n  };\n\n  const handleDragStart = ({ id }) => {\n    setDragActiveRowId(id);\n  };\n\n  const rowIds = localData.map((row) => row.id ?? row._id);\n\n  return (\n    <div\n      className={[\n        baseClass,\n        appearance && `${baseClass}--appearance-${appearance}`,\n      ]\n        .filter(Boolean)\n        .join(\" \")}\n    >\n      <DraggableSortable\n        ids={rowIds}\n        onDragEnd={handleDragEnd}\n        onDragStart={handleDragStart}\n      >\n        <table cellPadding=\"0\" cellSpacing=\"0\">\n          <thead>\n            <tr>\n              {activeColumns.map((col, i) => (\n                <th id={`heading-${col.accessor}`} key={i}>\n                  {col.Heading}\n                </th>\n              ))}\n            </tr>\n          </thead>\n          <tbody>\n            {localData.map((row, rowIndex) => (\n              <DraggableSortableItem\n                id={rowIds[rowIndex]}\n                key={rowIds[rowIndex]}\n              >\n                {({\n                  attributes,\n                  isDragging,\n                  listeners,\n                  setNodeRef,\n                  transform,\n                  transition,\n                }) => (\n                  <OrderableRow\n                    cellMap={cellMap}\n                    className={`row-${rowIndex + 1}`}\n                    columns={activeColumns}\n                    dragAttributes={attributes}\n                    dragListeners={listeners}\n                    ref={setNodeRef}\n                    rowId={row.id ?? row._id}\n                    style={{\n                      opacity: isDragging ? 0 : 1,\n                      transform,\n                      transition,\n                    }}\n                  />\n                )}\n              </DraggableSortableItem>\n            ))}\n          </tbody>\n        </table>\n\n        <DragOverlay>\n          <OrderableRowDragPreview\n            className={[baseClass, `${baseClass}--drag-preview`].join(\" \")}\n            rowId={dragActiveRowId}\n          >\n            <OrderableRow\n              cellMap={cellMap}\n              columns={activeColumns}\n              rowId={dragActiveRowId}\n            />\n          </OrderableRowDragPreview>\n        </DragOverlay>\n      </DraggableSortable>\n    </div>\n  );\n};\n"],"mappings":"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","ignoreList":[]}