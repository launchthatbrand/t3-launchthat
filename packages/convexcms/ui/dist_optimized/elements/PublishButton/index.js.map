{"version":3,"file":"index.js","names":["React","useCallback","useModal","qs","useForm","useFormModified","FormSubmit","useHotkey","useConfig","useDocumentInfo","useEditDepth","useLocale","useOperation","useTranslation","PopupList","ScheduleDrawer","PublishButton","label","labelProp","id","collectionSlug","docConfig","globalSlug","hasPublishedDoc","hasPublishPermission","setHasPublishedDoc","setMostRecentVersionIsAutosaved","setUnpublishedVersionCount","unpublishedVersionCount","uploadStatus","config","getEntityConfig","submit","modified","editDepth","code","localeCode","isModalOpen","toggleModal","drawerSlug","localization","routes","api","serverURL","t","entityConfig","useMemo","hasNewerVersions","canPublish","scheduledPublishEnabled","versions","drafts","schedulePublish","canSchedulePublish","Boolean","operation","disabled","saveDraft","search","action","method","overrides","_status","skipValidation","cmdCtrlKey","keyCodes","e","preventDefault","stopPropagation","autosave","publish","publishSpecificLocale","locale","params","stringify","publishAll","defaultLocalePublishOption","activeLocale","locales","find","activeLocaleLabel","undefined","defaultPublish","defaultLabel","secondaryPublish","secondaryLabel","_jsxs","Fragment","_jsx","buttonId","enableSubMenu","onClick","size","SubMenuPopupContent","close","ButtonGroup","Button","type","defaultType","slug"],"sources":["../../../src/elements/PublishButton/index.tsx"],"sourcesContent":["\"use client\";\n\nimport type { PublishButtonClientProps } from \"@convexcms/core\";\nimport React, { useCallback } from \"react\";\nimport { useModal } from \"@faceless-ui/modal\";\nimport * as qs from \"qs-esm\";\n\nimport { useForm, useFormModified } from \"../../forms/Form/context.js\";\nimport { FormSubmit } from \"../../forms/Submit/index.js\";\nimport { useHotkey } from \"../../hooks/useHotkey.js\";\nimport { useConfig } from \"../../providers/Config/index.js\";\nimport { useDocumentInfo } from \"../../providers/DocumentInfo/index.js\";\nimport { useEditDepth } from \"../../providers/EditDepth/index.js\";\nimport { useLocale } from \"../../providers/Locale/index.js\";\nimport { useOperation } from \"../../providers/Operation/index.js\";\nimport { useTranslation } from \"../../providers/Translation/index.js\";\nimport { PopupList } from \"../Popup/index.js\";\nimport { ScheduleDrawer } from \"./ScheduleDrawer/index.js\";\n\nexport function PublishButton({ label: labelProp }: PublishButtonClientProps) {\n  const {\n    id,\n    collectionSlug,\n    docConfig,\n    globalSlug,\n    hasPublishedDoc,\n    hasPublishPermission,\n    setHasPublishedDoc,\n    setMostRecentVersionIsAutosaved,\n    setUnpublishedVersionCount,\n    unpublishedVersionCount,\n    uploadStatus,\n  } = useDocumentInfo();\n\n  const { config, getEntityConfig } = useConfig();\n  const { submit } = useForm();\n  const modified = useFormModified();\n  const editDepth = useEditDepth();\n  const { code: localeCode } = useLocale();\n  const { isModalOpen, toggleModal } = useModal();\n\n  const drawerSlug = `schedule-publish-${id}`;\n\n  const {\n    localization,\n    routes: { api },\n    serverURL,\n  } = config;\n\n  const { t } = useTranslation();\n  const label = labelProp || t(\"version:publishChanges\");\n\n  const entityConfig = React.useMemo(() => {\n    if (collectionSlug) {\n      return getEntityConfig({ collectionSlug });\n    }\n\n    if (globalSlug) {\n      return getEntityConfig({ globalSlug });\n    }\n  }, [collectionSlug, globalSlug, getEntityConfig]);\n\n  const hasNewerVersions = unpublishedVersionCount > 0;\n\n  const canPublish =\n    hasPublishPermission &&\n    (modified || hasNewerVersions || !hasPublishedDoc) &&\n    uploadStatus !== \"uploading\";\n\n  const scheduledPublishEnabled =\n    typeof entityConfig?.versions?.drafts === \"object\" &&\n    entityConfig?.versions?.drafts.schedulePublish;\n\n  const canSchedulePublish = Boolean(\n    scheduledPublishEnabled &&\n      hasPublishPermission &&\n      (globalSlug || (collectionSlug && id)) &&\n      !modified,\n  );\n\n  const operation = useOperation();\n\n  const disabled = operation === \"update\" && !modified;\n\n  const saveDraft = useCallback(async () => {\n    if (disabled) {\n      return;\n    }\n\n    const search = `?locale=${localeCode}&depth=0&fallback-locale=null&draft=true`;\n    let action;\n    let method = \"POST\";\n\n    if (collectionSlug) {\n      action = `${serverURL}${api}/${collectionSlug}${id ? `/${id}` : \"\"}${search}`;\n      if (id) {\n        method = \"PATCH\";\n      }\n    }\n\n    if (globalSlug) {\n      action = `${serverURL}${api}/globals/${globalSlug}${search}`;\n    }\n\n    await submit({\n      action,\n      method,\n      overrides: {\n        _status: \"draft\",\n      },\n      skipValidation: true,\n    });\n  }, [\n    submit,\n    collectionSlug,\n    globalSlug,\n    serverURL,\n    api,\n    localeCode,\n    id,\n    disabled,\n  ]);\n\n  useHotkey({ cmdCtrlKey: true, editDepth, keyCodes: [\"s\"] }, (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n\n    if (\n      saveDraft &&\n      docConfig.versions?.drafts &&\n      docConfig.versions?.drafts?.autosave\n    ) {\n      void saveDraft();\n    }\n  });\n\n  const publish = useCallback(() => {\n    if (uploadStatus === \"uploading\") {\n      return;\n    }\n\n    void submit({\n      overrides: {\n        _status: \"published\",\n      },\n    });\n\n    setUnpublishedVersionCount(0);\n    setMostRecentVersionIsAutosaved(false);\n    setHasPublishedDoc(true);\n  }, [\n    setHasPublishedDoc,\n    submit,\n    setUnpublishedVersionCount,\n    uploadStatus,\n    setMostRecentVersionIsAutosaved,\n  ]);\n\n  const publishSpecificLocale = useCallback(\n    (locale) => {\n      if (uploadStatus === \"uploading\") {\n        return;\n      }\n\n      const params = qs.stringify({\n        publishSpecificLocale: locale,\n      });\n\n      const action = `${serverURL}${api}${\n        globalSlug\n          ? `/globals/${globalSlug}`\n          : `/${collectionSlug}/${id ? `${\"/\" + id}` : \"\"}`\n      }${params ? \"?\" + params : \"\"}`;\n\n      void submit({\n        action,\n        overrides: {\n          _status: \"published\",\n        },\n      });\n\n      setHasPublishedDoc(true);\n    },\n    [\n      api,\n      collectionSlug,\n      globalSlug,\n      id,\n      serverURL,\n      setHasPublishedDoc,\n      submit,\n      uploadStatus,\n    ],\n  );\n\n  const publishAll =\n    !localization ||\n    (localization && localization.defaultLocalePublishOption !== \"active\");\n\n  const activeLocale =\n    localization &&\n    localization?.locales.find((locale) =>\n      typeof locale === \"string\"\n        ? locale === localeCode\n        : locale.code === localeCode,\n    );\n\n  const activeLocaleLabel =\n    activeLocale &&\n    (typeof activeLocale.label === \"string\"\n      ? activeLocale.label\n      : (activeLocale.label?.[localeCode] ?? undefined));\n\n  const defaultPublish = publishAll\n    ? publish\n    : () => publishSpecificLocale(activeLocale.code);\n  const defaultLabel = publishAll\n    ? label\n    : t(\"version:publishIn\", { locale: activeLocaleLabel });\n\n  const secondaryPublish = publishAll\n    ? () => publishSpecificLocale(activeLocale.code)\n    : publish;\n  const secondaryLabel = publishAll\n    ? t(\"version:publishIn\", { locale: activeLocaleLabel })\n    : t(\"version:publishAllLocales\");\n\n  if (!hasPublishPermission) {\n    return null;\n  }\n\n  return (\n    <React.Fragment>\n      <FormSubmit\n        buttonId=\"action-save\"\n        disabled={!canPublish}\n        enableSubMenu={canSchedulePublish}\n        onClick={defaultPublish}\n        size=\"medium\"\n        SubMenuPopupContent={\n          localization || canSchedulePublish\n            ? ({ close }) => {\n                return (\n                  <React.Fragment>\n                    {canSchedulePublish && (\n                      <PopupList.ButtonGroup key=\"schedule-publish\">\n                        <PopupList.Button\n                          id=\"schedule-publish\"\n                          onClick={() => [toggleModal(drawerSlug), close()]}\n                        >\n                          {t(\"version:schedulePublish\")}\n                        </PopupList.Button>\n                      </PopupList.ButtonGroup>\n                    )}\n                    {localization && canPublish && (\n                      <PopupList.ButtonGroup>\n                        <PopupList.Button\n                          id=\"publish-locale\"\n                          onClick={secondaryPublish}\n                        >\n                          {secondaryLabel}\n                        </PopupList.Button>\n                      </PopupList.ButtonGroup>\n                    )}\n                  </React.Fragment>\n                );\n              }\n            : undefined\n        }\n        type=\"button\"\n      >\n        {localization ? defaultLabel : label}\n      </FormSubmit>\n      {canSchedulePublish && isModalOpen(drawerSlug) && (\n        <ScheduleDrawer\n          defaultType={!hasNewerVersions ? \"unpublish\" : \"publish\"}\n          slug={drawerSlug}\n        />\n      )}\n    </React.Fragment>\n  );\n}\n"],"mappings":"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","ignoreList":[]}