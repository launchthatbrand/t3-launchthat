{"version":3,"file":"index.js","names":["React","validateMimeType","useModal","toast","useConfig","useTranslation","Drawer","useDrawerDepth","AddFilesView","AddingFilesView","FormsManagerProvider","useFormsManager","drawerSlug","DrawerContent","addFiles","forms","isInitializing","closeModal","collectionSlug","useBulkUpload","getEntityConfig","t","uploadCollection","uploadConfig","upload","uploadMimeTypes","mimeTypes","onDrop","useCallback","acceptedFiles","fileTransfer","DataTransfer","candidateFile","undefined","length","type","items","add","files","error","_jsx","acceptMimeTypes","join","onCancel","BulkUploadDrawer","gutter","Header","slug","Context","createContext","currentActivePath","initialFiles","maxFiles","onSuccess","setCollectionSlug","setCurrentActivePath","setInitialFiles","setMaxFiles","setOnCancel","setOnSuccess","BulkUploadProvider","children","collection","setCollection","useState","onSuccessFunctionMap","setOnSuccessFunctionMap","onCancelFunction","setOnCancelFunction","useBulkUploadDrawerSlug","path","prev","value","docIDs","errorCount","Object","hasOwn","onSuccessFunction","_jsxs","Fragment","use","depth"],"sources":["../../../src/elements/BulkUpload/index.tsx"],"sourcesContent":["\"use client\";\n\nimport type { JsonObject } from \"@convexcms/core\";\nimport React from \"react\";\nimport { validateMimeType } from \"@convexcms/core/shared\";\nimport { useModal } from \"@faceless-ui/modal\";\nimport { toast } from \"sonner\";\n\nimport { useConfig } from \"../../providers/Config/index.js\";\nimport { useTranslation } from \"../../providers/Translation/index.js\";\nimport { Drawer, useDrawerDepth } from \"../Drawer/index.js\";\nimport { AddFilesView } from \"./AddFilesView/index.js\";\nimport { AddingFilesView } from \"./AddingFilesView/index.js\";\nimport { FormsManagerProvider, useFormsManager } from \"./FormsManager/index.js\";\n\nconst drawerSlug = \"bulk-upload-drawer-slug\";\n\nfunction DrawerContent() {\n  const { addFiles, forms, isInitializing } = useFormsManager();\n  const { closeModal } = useModal();\n  const { collectionSlug, drawerSlug } = useBulkUpload();\n  const { getEntityConfig } = useConfig();\n  const { t } = useTranslation();\n\n  const uploadCollection = getEntityConfig({ collectionSlug });\n  const uploadConfig = uploadCollection?.upload;\n  const uploadMimeTypes = uploadConfig?.mimeTypes;\n\n  const onDrop = React.useCallback(\n    (acceptedFiles: FileList) => {\n      const fileTransfer = new DataTransfer();\n      for (const candidateFile of acceptedFiles) {\n        if (\n          uploadMimeTypes === undefined ||\n          uploadMimeTypes.length === 0 ||\n          validateMimeType(candidateFile.type, uploadMimeTypes)\n        ) {\n          fileTransfer.items.add(candidateFile);\n        }\n      }\n      if (fileTransfer.files.length === 0) {\n        toast.error(t(\"error:invalidFileType\"));\n      } else {\n        void addFiles(fileTransfer.files);\n      }\n    },\n    [addFiles, t, uploadMimeTypes],\n  );\n\n  if (!collectionSlug) {\n    return null;\n  }\n\n  if (!forms.length && !isInitializing) {\n    return (\n      <AddFilesView\n        acceptMimeTypes={uploadMimeTypes?.join(\", \")}\n        onCancel={() => closeModal(drawerSlug)}\n        onDrop={onDrop}\n      />\n    );\n  } else {\n    return <AddingFilesView />;\n  }\n}\n\nexport type BulkUploadProps = {\n  readonly children: React.ReactNode;\n};\n\nexport function BulkUploadDrawer() {\n  const { drawerSlug } = useBulkUpload();\n\n  return (\n    <Drawer gutter={false} Header={null} slug={drawerSlug}>\n      <FormsManagerProvider>\n        <DrawerContent />\n      </FormsManagerProvider>\n    </Drawer>\n  );\n}\n\ntype BulkUploadContext = {\n  collectionSlug: string;\n  currentActivePath: string;\n  drawerSlug: string;\n  initialFiles: FileList;\n  maxFiles: number;\n  onCancel: () => void;\n  onSuccess: (newDocs: JsonObject[], errorCount: number) => void;\n  setCollectionSlug: (slug: string) => void;\n  setCurrentActivePath: (path: string) => void;\n  setInitialFiles: (files: FileList) => void;\n  setMaxFiles: (maxFiles: number) => void;\n  setOnCancel: (onCancel: BulkUploadContext[\"onCancel\"]) => void;\n  setOnSuccess: (\n    path: string,\n    onSuccess: BulkUploadContext[\"onSuccess\"],\n  ) => void;\n};\n\nconst Context = React.createContext<BulkUploadContext>({\n  collectionSlug: \"\",\n  currentActivePath: undefined,\n  drawerSlug: \"\",\n  initialFiles: undefined,\n  maxFiles: undefined,\n  onCancel: () => null,\n  onSuccess: () => null,\n  setCollectionSlug: () => null,\n  setCurrentActivePath: () => null,\n  setInitialFiles: () => null,\n  setMaxFiles: () => null,\n  setOnCancel: () => null,\n  setOnSuccess: () => null,\n});\nexport function BulkUploadProvider({\n  children,\n}: {\n  readonly children: React.ReactNode;\n}) {\n  const [collection, setCollection] = React.useState<string>();\n  const [onSuccessFunctionMap, setOnSuccessFunctionMap] =\n    React.useState<Record<string, BulkUploadContext[\"onSuccess\"]>>();\n  const [onCancelFunction, setOnCancelFunction] =\n    React.useState<BulkUploadContext[\"onCancel\"]>();\n  const [initialFiles, setInitialFiles] = React.useState<FileList>(undefined);\n  const [maxFiles, setMaxFiles] = React.useState<number>(undefined);\n  const [currentActivePath, setCurrentActivePath] =\n    React.useState<string>(undefined);\n  const drawerSlug = useBulkUploadDrawerSlug();\n\n  const setCollectionSlug: BulkUploadContext[\"setCollectionSlug\"] = (slug) => {\n    setCollection(slug);\n  };\n\n  const setOnSuccess: BulkUploadContext[\"setOnSuccess\"] = React.useCallback(\n    (path, onSuccess) => {\n      setOnSuccessFunctionMap((prev) => ({\n        ...prev,\n        [path]: onSuccess,\n      }));\n    },\n    [],\n  );\n\n  return (\n    <Context\n      value={{\n        collectionSlug: collection,\n        currentActivePath,\n        drawerSlug,\n        initialFiles,\n        maxFiles,\n        onCancel: () => {\n          if (typeof onCancelFunction === \"function\") {\n            onCancelFunction();\n          }\n        },\n        onSuccess: (docIDs, errorCount) => {\n          if (\n            onSuccessFunctionMap &&\n            Object.hasOwn(onSuccessFunctionMap, currentActivePath)\n          ) {\n            const onSuccessFunction = onSuccessFunctionMap[currentActivePath];\n            onSuccessFunction(docIDs, errorCount);\n          }\n        },\n        setCollectionSlug,\n        setCurrentActivePath,\n        setInitialFiles,\n        setMaxFiles,\n        setOnCancel: setOnCancelFunction,\n        setOnSuccess,\n      }}\n    >\n      <React.Fragment>\n        {children}\n        <BulkUploadDrawer />\n      </React.Fragment>\n    </Context>\n  );\n}\n\nexport const useBulkUpload = () => React.use(Context);\n\nexport function useBulkUploadDrawerSlug() {\n  const depth = useDrawerDepth();\n\n  return `${drawerSlug}-${depth || 1}`;\n}\n"],"mappings":"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","ignoreList":[]}