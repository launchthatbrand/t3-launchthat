{"version":3,"file":"index.js","names":["React","isImage","useModal","qs","toast","fieldReducer","useConfig","useLocale","useServerFunctions","useTranslation","useUploadHandlers","hasSavePermission","getHasSavePermission","LoadingOverlay","useLoadingOverlay","createThumbnail","useBulkUpload","createFormData","formsManagementReducer","Context","createContext","activeIndex","addFiles","Promise","resolve","bulkUpdateForm","collectionSlug","docPermissions","undefined","documentSlots","forms","getFormDataRef","current","hasPublishPermission","hasSubmitted","isInitializing","removeFile","saveAllDocs","setActiveIndex","setFormTotalErrorCount","thumbnailUrls","totalErrorCount","initialState","FormsManagerProvider","children","config","routes","api","serverURL","code","i18n","t","getDocumentSlots","getFormState","getUploadHandler","setDocumentSlots","useState","setHasSubmitted","setDocPermissions","setHasSavePermission","setHasPublishPermission","hasInitializedState","setHasInitializedState","hasInitializedDocPermissions","setHasInitializedDocPermissions","setIsInitializing","state","dispatch","useReducer","formsRef","useRef","formsCount","length","thumbnailUrlsRef","processedFiles","Set","renderedThumbnails","setRenderedThumbnails","useEffect","newThumbnails","i","file","formState","value","has","type","add","thumbnailUrl","setTimeout","toggleLoadingOverlay","closeModal","drawerSlug","initialFiles","onSuccess","isUploading","setIsUploading","loadingText","setLoadingText","hasInitializedWithFiles","initialStateRef","actionURL","initializeSharedDocPermissions","useCallback","params","locale","docAccessURL","res","fetch","stringify","credentials","headers","language","method","json","publishedAccessJSON","body","JSON","_status","then","isEditing","update","initializeSharedFormState","abortController","signal","abort","formStateWithoutFiles","docPreferences","fields","operation","renderAllFields","schemaPath","skipValidation","_err","index","currentFormsData","map","form","errorCount","files","isLoading","key","removeThumbnails","indexes","filter","_","includes","count","overrides","currentForms","newDocs","total","req","status","doc","push","fieldErrors","nonFieldErrors","errors","reduce","fieldErrs","nonFieldErrs","err","newFieldErrs","newNonFieldErrs","message","Array","isArray","data","forEach","dataError","path","error","remainingForms","thumbnailIndexesToRemove","successCount","Math","max","success","acc","updatedFields","afterStateUpdate","Object","entries","newFormErrorCount","values","valid","_jsxs","_jsx","animationDuration","overlayType","show","useFormsManager","use"],"sources":["../../../../src/elements/BulkUpload/FormsManager/index.tsx"],"sourcesContent":["\"use client\";\n\nimport type {\n  Data,\n  DocumentSlots,\n  FormState,\n  SanitizedDocumentPermissions,\n} from \"@convexcms/core\";\nimport React from \"react\";\nimport { isImage } from \"@convexcms/core/shared\";\nimport { useModal } from \"@faceless-ui/modal\";\nimport * as qs from \"qs-esm\";\nimport { toast } from \"sonner\";\n\nimport type { State } from \"./reducer.js\";\nimport { fieldReducer } from \"../../../forms/Form/fieldReducer.js\";\nimport { useConfig } from \"../../../providers/Config/index.js\";\nimport { useLocale } from \"../../../providers/Locale/index.js\";\nimport { useServerFunctions } from \"../../../providers/ServerFunctions/index.js\";\nimport { useTranslation } from \"../../../providers/Translation/index.js\";\nimport { useUploadHandlers } from \"../../../providers/UploadHandlers/index.js\";\nimport { hasSavePermission as getHasSavePermission } from \"../../../utilities/hasSavePermission.js\";\nimport { LoadingOverlay } from \"../../Loading/index.js\";\nimport { useLoadingOverlay } from \"../../LoadingOverlay/index.js\";\nimport { createThumbnail } from \"../../Thumbnail/createThumbnail.js\";\nimport { useBulkUpload } from \"../index.js\";\nimport { createFormData } from \"./createFormData.js\";\nimport { formsManagementReducer } from \"./reducer.js\";\n\ntype FormsManagerContext = {\n  readonly activeIndex: State[\"activeIndex\"];\n  readonly addFiles: (filelist: FileList) => Promise<void>;\n  readonly bulkUpdateForm: (\n    updatedFields: Record<string, unknown>,\n    afterStateUpdate?: () => void,\n  ) => Promise<void>;\n  readonly collectionSlug: string;\n  readonly docPermissions?: SanitizedDocumentPermissions;\n  readonly documentSlots: DocumentSlots;\n  readonly forms: State[\"forms\"];\n  getFormDataRef: React.RefObject<() => Data>;\n  readonly hasPublishPermission: boolean;\n  readonly hasSavePermission: boolean;\n  readonly hasSubmitted: boolean;\n  readonly isInitializing: boolean;\n  readonly removeFile: (index: number) => void;\n  readonly saveAllDocs: ({\n    overrides,\n  }?: {\n    overrides?: Record<string, unknown>;\n  }) => Promise<void>;\n  readonly setActiveIndex: (index: number) => void;\n  readonly setFormTotalErrorCount: ({\n    errorCount,\n    index,\n  }: {\n    errorCount: number;\n    index: number;\n  }) => void;\n  readonly thumbnailUrls: string[];\n  readonly totalErrorCount?: number;\n};\n\nconst Context = React.createContext<FormsManagerContext>({\n  activeIndex: 0,\n  addFiles: () => Promise.resolve(),\n  bulkUpdateForm: () => null,\n  collectionSlug: \"\",\n  docPermissions: undefined,\n  documentSlots: {},\n  forms: [],\n  getFormDataRef: { current: () => ({}) },\n  hasPublishPermission: false,\n  hasSavePermission: false,\n  hasSubmitted: false,\n  isInitializing: false,\n  removeFile: () => {},\n  saveAllDocs: () => Promise.resolve(),\n  setActiveIndex: () => 0,\n  setFormTotalErrorCount: () => {},\n  thumbnailUrls: [],\n  totalErrorCount: 0,\n});\n\nconst initialState: State = {\n  activeIndex: 0,\n  forms: [],\n  totalErrorCount: 0,\n};\n\ntype FormsManagerProps = {\n  readonly children: React.ReactNode;\n};\n\nexport function FormsManagerProvider({ children }: FormsManagerProps) {\n  const { config } = useConfig();\n  const {\n    routes: { api },\n    serverURL,\n  } = config;\n  const { code } = useLocale();\n  const { i18n, t } = useTranslation();\n\n  const { getDocumentSlots, getFormState } = useServerFunctions();\n  const { getUploadHandler } = useUploadHandlers();\n\n  const [documentSlots, setDocumentSlots] = React.useState<DocumentSlots>({});\n  const [hasSubmitted, setHasSubmitted] = React.useState(false);\n  const [docPermissions, setDocPermissions] =\n    React.useState<SanitizedDocumentPermissions>();\n  const [hasSavePermission, setHasSavePermission] = React.useState(false);\n  const [hasPublishPermission, setHasPublishPermission] = React.useState(false);\n  const [hasInitializedState, setHasInitializedState] = React.useState(false);\n  const [hasInitializedDocPermissions, setHasInitializedDocPermissions] =\n    React.useState(false);\n  const [isInitializing, setIsInitializing] = React.useState(false);\n  const [state, dispatch] = React.useReducer(\n    formsManagementReducer,\n    initialState,\n  );\n  const { activeIndex, forms, totalErrorCount } = state;\n\n  const formsRef = React.useRef(forms);\n  formsRef.current = forms;\n  const formsCount = forms.length;\n\n  const thumbnailUrlsRef = React.useRef<string[]>([]);\n  const processedFiles = React.useRef(new Set()); // Track already-processed files\n  const [renderedThumbnails, setRenderedThumbnails] = React.useState<string[]>(\n    [],\n  );\n\n  React.useEffect(() => {\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    (async () => {\n      const newThumbnails = [...thumbnailUrlsRef.current];\n\n      for (let i = 0; i < formsCount; i++) {\n        const file = formsRef.current[i].formState.file.value as File;\n\n        // Skip if already processed\n        if (processedFiles.current.has(file) || !file || !isImage(file.type)) {\n          continue;\n        }\n        processedFiles.current.add(file);\n\n        // Generate thumbnail and update ref\n        const thumbnailUrl = await createThumbnail(file);\n        newThumbnails[i] = thumbnailUrl;\n        thumbnailUrlsRef.current = newThumbnails;\n\n        // Trigger re-render in batches\n        setRenderedThumbnails([...newThumbnails]);\n        await new Promise((resolve) => setTimeout(resolve, 100));\n      }\n    })();\n  }, [formsCount]);\n\n  const { toggleLoadingOverlay } = useLoadingOverlay();\n  const { closeModal } = useModal();\n  const { collectionSlug, drawerSlug, initialFiles, onSuccess } =\n    useBulkUpload();\n\n  const [isUploading, setIsUploading] = React.useState(false);\n  const [loadingText, setLoadingText] = React.useState(\"\");\n\n  const hasInitializedWithFiles = React.useRef(false);\n  const initialStateRef = React.useRef<FormState>(null);\n  const getFormDataRef = React.useRef<() => Data>(() => ({}));\n\n  const actionURL = `${api}/${collectionSlug}`;\n\n  const initializeSharedDocPermissions = React.useCallback(async () => {\n    const params = {\n      locale: code || undefined,\n    };\n\n    const docAccessURL = `/${collectionSlug}/access`;\n    const res = await fetch(\n      `${serverURL}${api}${docAccessURL}?${qs.stringify(params)}`,\n      {\n        credentials: \"include\",\n        headers: {\n          \"Accept-Language\": i18n.language,\n          \"Content-Type\": \"application/json\",\n        },\n        method: \"post\",\n      },\n    );\n\n    const json: SanitizedDocumentPermissions = await res.json();\n    const publishedAccessJSON = await fetch(\n      `${serverURL}${api}${docAccessURL}?${qs.stringify(params)}`,\n      {\n        body: JSON.stringify({\n          _status: \"published\",\n        }),\n        credentials: \"include\",\n        headers: {\n          \"Accept-Language\": i18n.language,\n          \"Content-Type\": \"application/json\",\n        },\n        method: \"POST\",\n      },\n    ).then((res) => res.json());\n\n    setDocPermissions(json);\n\n    setHasSavePermission(\n      getHasSavePermission({\n        collectionSlug,\n        docPermissions: json,\n        isEditing: false,\n      }),\n    );\n\n    setHasPublishPermission(publishedAccessJSON?.update);\n    setHasInitializedDocPermissions(true);\n  }, [api, code, collectionSlug, i18n.language, serverURL]);\n\n  const initializeSharedFormState = React.useCallback(\n    async (abortController?: AbortController) => {\n      if (abortController?.signal) {\n        abortController.abort(\n          \"aborting previous fetch for initial form state without files\",\n        );\n      }\n\n      // FETCH AND SET THE DOCUMENT SLOTS HERE!\n      const documentSlots = await getDocumentSlots({ collectionSlug });\n      setDocumentSlots(documentSlots);\n\n      try {\n        const { state: formStateWithoutFiles } = await getFormState({\n          collectionSlug,\n          docPermissions,\n          docPreferences: { fields: {} },\n          locale: code,\n          operation: \"create\",\n          renderAllFields: true,\n          schemaPath: collectionSlug,\n          skipValidation: true,\n        });\n        initialStateRef.current = formStateWithoutFiles;\n        setHasInitializedState(true);\n      } catch (_err) {\n        // swallow error\n      }\n    },\n    [getDocumentSlots, collectionSlug, getFormState, docPermissions, code],\n  );\n\n  const setActiveIndex: FormsManagerContext[\"setActiveIndex\"] =\n    React.useCallback(\n      (index: number) => {\n        const currentFormsData = getFormDataRef.current();\n        dispatch({\n          type: \"REPLACE\",\n          state: {\n            activeIndex: index,\n            forms: forms.map((form, i) => {\n              if (i === activeIndex) {\n                return {\n                  errorCount: form.errorCount,\n                  formState: currentFormsData,\n                };\n              }\n              return form;\n            }),\n          },\n        });\n      },\n      [forms, activeIndex],\n    );\n\n  const addFiles = React.useCallback(\n    async (files: FileList) => {\n      toggleLoadingOverlay({ isLoading: true, key: \"addingDocs\" });\n      if (!hasInitializedState) {\n        await initializeSharedFormState();\n      }\n      dispatch({\n        type: \"ADD_FORMS\",\n        files,\n        initialState: initialStateRef.current,\n      });\n      toggleLoadingOverlay({ isLoading: false, key: \"addingDocs\" });\n    },\n    [initializeSharedFormState, hasInitializedState, toggleLoadingOverlay],\n  );\n\n  const removeThumbnails = React.useCallback((indexes: number[]) => {\n    thumbnailUrlsRef.current = thumbnailUrlsRef.current.filter(\n      (_, i) => !indexes.includes(i),\n    );\n    setRenderedThumbnails([...thumbnailUrlsRef.current]);\n  }, []);\n\n  const removeFile: FormsManagerContext[\"removeFile\"] = React.useCallback(\n    (index) => {\n      dispatch({ type: \"REMOVE_FORM\", index });\n      removeThumbnails([index]);\n    },\n    [removeThumbnails],\n  );\n\n  const setFormTotalErrorCount: FormsManagerContext[\"setFormTotalErrorCount\"] =\n    React.useCallback(({ errorCount, index }) => {\n      dispatch({\n        type: \"UPDATE_ERROR_COUNT\",\n        count: errorCount,\n        index,\n      });\n    }, []);\n\n  const saveAllDocs: FormsManagerContext[\"saveAllDocs\"] = React.useCallback(\n    async ({ overrides } = {}) => {\n      const currentFormsData = getFormDataRef.current();\n      const currentForms = [...forms];\n      currentForms[activeIndex] = {\n        errorCount: currentForms[activeIndex].errorCount,\n        formState: currentFormsData,\n      };\n      const newDocs = [];\n\n      setIsUploading(true);\n\n      for (let i = 0; i < currentForms.length; i++) {\n        try {\n          const form = currentForms[i];\n\n          setLoadingText(\n            t(\"general:uploadingBulk\", {\n              current: i + 1,\n              total: currentForms.length,\n            }),\n          );\n\n          const req = await fetch(actionURL, {\n            body: await createFormData(\n              form.formState,\n              overrides,\n              collectionSlug,\n              getUploadHandler({ collectionSlug }),\n            ),\n            method: \"POST\",\n          });\n\n          const json = await req.json();\n\n          if (req.status === 201 && json?.doc) {\n            newDocs.push(json.doc);\n          }\n\n          // should expose some sort of helper for this\n          const [fieldErrors, nonFieldErrors] = (json?.errors || []).reduce(\n            ([fieldErrs, nonFieldErrs], err) => {\n              const newFieldErrs: any[] = [];\n              const newNonFieldErrs: any[] = [];\n\n              if (err?.message) {\n                newNonFieldErrs.push(err);\n              }\n\n              if (Array.isArray(err?.data?.errors)) {\n                err.data?.errors.forEach((dataError) => {\n                  if (dataError?.path) {\n                    newFieldErrs.push(dataError);\n                  } else {\n                    newNonFieldErrs.push(dataError);\n                  }\n                });\n              }\n\n              return [\n                [...fieldErrs, ...newFieldErrs],\n                [...nonFieldErrs, ...newNonFieldErrs],\n              ];\n            },\n            [[], []],\n          );\n\n          currentForms[i] = {\n            errorCount: fieldErrors.length,\n            formState: fieldReducer(currentForms[i].formState, {\n              type: \"ADD_SERVER_ERRORS\",\n              errors: fieldErrors,\n            }),\n          };\n\n          if (req.status === 413 || req.status === 400) {\n            // file too large\n            currentForms[i] = {\n              ...currentForms[i],\n              errorCount: currentForms[i].errorCount + 1,\n            };\n\n            toast.error(nonFieldErrors[0]?.message);\n          }\n        } catch (_) {\n          // swallow\n        }\n      }\n\n      setHasSubmitted(true);\n      setLoadingText(\"\");\n      setIsUploading(false);\n\n      const remainingForms = [];\n      const thumbnailIndexesToRemove = [];\n\n      currentForms.forEach(({ errorCount }, i) => {\n        if (errorCount) {\n          remainingForms.push(currentForms[i]);\n        } else {\n          thumbnailIndexesToRemove.push(i);\n        }\n      });\n\n      const successCount = Math.max(\n        0,\n        currentForms.length - remainingForms.length,\n      );\n      const errorCount = currentForms.length - successCount;\n\n      if (successCount) {\n        toast.success(`Successfully saved ${successCount} files`);\n\n        if (typeof onSuccess === \"function\") {\n          onSuccess(newDocs, errorCount);\n        }\n\n        if (remainingForms.length && thumbnailIndexesToRemove.length) {\n          removeThumbnails(thumbnailIndexesToRemove);\n        }\n      }\n\n      if (errorCount) {\n        toast.error(`Failed to save ${errorCount} files`);\n      } else {\n        closeModal(drawerSlug);\n      }\n\n      dispatch({\n        type: \"REPLACE\",\n        state: {\n          activeIndex: 0,\n          forms: remainingForms,\n          totalErrorCount: remainingForms.reduce(\n            (acc, { errorCount }) => acc + errorCount,\n            0,\n          ),\n        },\n      });\n    },\n    [\n      actionURL,\n      activeIndex,\n      forms,\n      removeThumbnails,\n      onSuccess,\n      collectionSlug,\n      getUploadHandler,\n      t,\n      closeModal,\n      drawerSlug,\n    ],\n  );\n\n  const bulkUpdateForm = React.useCallback(\n    async (\n      updatedFields: Record<string, unknown>,\n      afterStateUpdate?: () => void,\n    ) => {\n      for (let i = 0; i < forms.length; i++) {\n        Object.entries(updatedFields).forEach(([path, value]) => {\n          if (forms[i].formState[path]) {\n            forms[i].formState[path].value = value;\n\n            dispatch({\n              type: \"UPDATE_FORM\",\n              errorCount: forms[i].errorCount,\n              formState: forms[i].formState,\n              index: i,\n            });\n          }\n        });\n\n        if (typeof afterStateUpdate === \"function\") {\n          afterStateUpdate();\n        }\n\n        if (hasSubmitted) {\n          const { state } = await getFormState({\n            collectionSlug,\n            docPermissions,\n            docPreferences: null,\n            formState: forms[i].formState,\n            operation: \"create\",\n            schemaPath: collectionSlug,\n          });\n\n          const newFormErrorCount = Object.values(state).reduce(\n            (acc, value) => (value?.valid === false ? acc + 1 : acc),\n            0,\n          );\n\n          dispatch({\n            type: \"UPDATE_FORM\",\n            errorCount: newFormErrorCount,\n            formState: state,\n            index: i,\n          });\n        }\n      }\n    },\n    [collectionSlug, docPermissions, forms, getFormState, hasSubmitted],\n  );\n\n  React.useEffect(() => {\n    if (!collectionSlug) {\n      return;\n    }\n    if (!hasInitializedState) {\n      void initializeSharedFormState();\n    }\n\n    if (!hasInitializedDocPermissions) {\n      void initializeSharedDocPermissions();\n    }\n\n    if (initialFiles) {\n      if (!hasInitializedState || !hasInitializedDocPermissions) {\n        setIsInitializing(true);\n      } else {\n        setIsInitializing(false);\n      }\n    }\n\n    if (\n      hasInitializedState &&\n      initialFiles &&\n      !hasInitializedWithFiles.current\n    ) {\n      void addFiles(initialFiles);\n      hasInitializedWithFiles.current = true;\n    }\n    return;\n  }, [\n    addFiles,\n    initialFiles,\n    initializeSharedFormState,\n    initializeSharedDocPermissions,\n    collectionSlug,\n    hasInitializedState,\n    hasInitializedDocPermissions,\n  ]);\n\n  return (\n    <Context\n      value={{\n        activeIndex: state.activeIndex,\n        addFiles,\n        bulkUpdateForm,\n        collectionSlug,\n        docPermissions,\n        documentSlots,\n        forms,\n        getFormDataRef,\n        hasPublishPermission,\n        hasSavePermission,\n        hasSubmitted,\n        isInitializing,\n        removeFile,\n        saveAllDocs,\n        setActiveIndex,\n        setFormTotalErrorCount,\n        thumbnailUrls: renderedThumbnails,\n        totalErrorCount,\n      }}\n    >\n      {isUploading && (\n        <LoadingOverlay\n          animationDuration=\"250ms\"\n          loadingText={loadingText}\n          overlayType=\"fullscreen\"\n          show\n        />\n      )}\n      {children}\n    </Context>\n  );\n}\n\nexport function useFormsManager() {\n  return React.use(Context);\n}\n"],"mappings":"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","ignoreList":[]}