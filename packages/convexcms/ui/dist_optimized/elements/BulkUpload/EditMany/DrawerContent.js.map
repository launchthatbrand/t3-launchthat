{"version":3,"file":"DrawerContent.js","names":["React","useCallback","useEffect","useMemo","useState","unflatten","getTranslation","useModal","Button","Form","RenderField","XIcon","useAuth","useServerFunctions","useTranslation","abortAndIgnore","handleAbortRef","FieldSelect","useFormsManager","baseClass","EditManyBulkUploadsDrawerContent","props","collection","fields","labels","plural","singular","drawerSlug","forms","isInitializing","setIsInitializing","permissions","i18n","t","closeModal","bulkUpdateForm","getFormState","abortFormStateRef","useRef","selectedFields","setSelectedFields","collectionPermissions","collections","slug","select","reduce","acc","option","value","path","onChange","formState","prevFormState","submitted","controller","state","collectionSlug","docPermissions","docPreferences","operation","schemaPath","signal","skipValidation","current","abortFormState","handleSubmit","pairedData","onFieldSelect","dispatchFields","selected","type","_jsxs","className","_jsx","count","length","label","id","onClick","onSubmit","map","i","field","fieldPermissions","clientFieldConfig","indexPath","parentPath","parentSchemaPath"],"sources":["../../../../src/elements/BulkUpload/EditMany/DrawerContent.tsx"],"sourcesContent":["\"use client\";\n\nimport \"./index.scss\";\nimport \"../../../forms/RenderFields/index.scss\";\n\nimport type { ClientCollectionConfig, SelectType } from \"@convexcms/core\";\nimport React, { useCallback, useEffect, useMemo, useState } from \"react\";\nimport { unflatten } from \"@convexcms/core/shared\";\nimport { getTranslation } from \"@convexcms/translations\";\nimport { useModal } from \"@faceless-ui/modal\";\n\nimport type { FormProps } from \"../../../forms/Form/index.js\";\nimport type { OnFieldSelect } from \"../../FieldSelect/index.js\";\nimport type { FieldOption } from \"../../FieldSelect/reduceFieldOptions.js\";\nimport type { State } from \"../FormsManager/reducer.js\";\nimport type { EditManyBulkUploadsProps } from \"./index.js\";\nimport { Button } from \"../../../elements/Button/index.js\";\nimport { Form } from \"../../../forms/Form/index.js\";\nimport { RenderField } from \"../../../forms/RenderFields/RenderField.js\";\nimport { XIcon } from \"../../../icons/X/index.js\";\nimport { useAuth } from \"../../../providers/Auth/index.js\";\nimport { useServerFunctions } from \"../../../providers/ServerFunctions/index.js\";\nimport { useTranslation } from \"../../../providers/Translation/index.js\";\nimport {\n  abortAndIgnore,\n  handleAbortRef,\n} from \"../../../utilities/abortAndIgnore.js\";\nimport { FieldSelect } from \"../../FieldSelect/index.js\";\nimport { useFormsManager } from \"../FormsManager/index.js\";\nimport { baseClass } from \"./index.js\";\n\nexport const EditManyBulkUploadsDrawerContent: React.FC<\n  {\n    collection: ClientCollectionConfig;\n    drawerSlug: string;\n    forms: State[\"forms\"];\n  } & EditManyBulkUploadsProps\n> = (props) => {\n  const {\n    collection: { fields, labels: { plural, singular } } = {},\n    collection,\n    drawerSlug,\n    forms,\n  } = props;\n\n  const [isInitializing, setIsInitializing] = useState(false);\n  const { permissions } = useAuth();\n  const { i18n, t } = useTranslation();\n  const { closeModal } = useModal();\n  const { bulkUpdateForm } = useFormsManager();\n  const { getFormState } = useServerFunctions();\n  const abortFormStateRef = React.useRef<AbortController>(null);\n\n  const [selectedFields, setSelectedFields] = useState<FieldOption[]>([]);\n  const collectionPermissions = permissions?.collections?.[collection.slug];\n\n  const select = useMemo<SelectType>(() => {\n    return unflatten(\n      selectedFields.reduce((acc, option) => {\n        acc[option.value.path] = true;\n        return acc;\n      }, {} as SelectType),\n    );\n  }, [selectedFields]);\n\n  const onChange: FormProps[\"onChange\"][0] = useCallback(\n    async ({ formState: prevFormState, submitted }) => {\n      const controller = handleAbortRef(abortFormStateRef);\n\n      const { state } = await getFormState({\n        collectionSlug: collection.slug,\n        docPermissions: collectionPermissions,\n        docPreferences: null,\n        formState: prevFormState,\n        operation: \"update\",\n        schemaPath: collection.slug,\n        select,\n        signal: controller.signal,\n        skipValidation: !submitted,\n      });\n\n      abortFormStateRef.current = null;\n\n      return state;\n    },\n    [getFormState, collection, collectionPermissions, select],\n  );\n\n  useEffect(() => {\n    const abortFormState = abortFormStateRef.current;\n\n    return () => {\n      abortAndIgnore(abortFormState);\n    };\n  }, []);\n\n  const handleSubmit: FormProps[\"onSubmit\"] = useCallback(\n    (formState) => {\n      const pairedData = selectedFields.reduce((acc, option) => {\n        if (formState[option.value.path]) {\n          acc[option.value.path] = formState[option.value.path].value;\n        }\n        return acc;\n      }, {});\n\n      void bulkUpdateForm(pairedData, () => closeModal(drawerSlug));\n    },\n    [closeModal, drawerSlug, bulkUpdateForm, selectedFields],\n  );\n\n  const onFieldSelect = useCallback<OnFieldSelect>(\n    async ({ dispatchFields, formState, selected }) => {\n      setIsInitializing(true);\n\n      setSelectedFields(selected || []);\n\n      const { state } = await getFormState({\n        collectionSlug: collection.slug,\n        docPermissions: collectionPermissions,\n        docPreferences: null,\n        formState,\n        operation: \"update\",\n        schemaPath: collection.slug,\n        select: unflatten(\n          selected.reduce((acc, option) => {\n            acc[option.value.path] = true;\n            return acc;\n          }, {} as SelectType),\n        ),\n        skipValidation: true,\n      });\n\n      dispatchFields({\n        type: \"UPDATE_MANY\",\n        formState: state,\n      });\n\n      setIsInitializing(false);\n    },\n    [getFormState, collection, collectionPermissions],\n  );\n\n  return (\n    <div className={`${baseClass}__main`}>\n      <div className={`${baseClass}__header`}>\n        <h2 className={`${baseClass}__header__title`}>\n          {t(\"general:editingLabel\", {\n            count: forms.length,\n            label: getTranslation(forms.length > 1 ? plural : singular, i18n),\n          })}\n        </h2>\n        <button\n          aria-label={t(\"general:close\")}\n          className={`${baseClass}__header__close`}\n          id={`close-drawer__${drawerSlug}`}\n          onClick={() => closeModal(drawerSlug)}\n          type=\"button\"\n        >\n          <XIcon />\n        </button>\n      </div>\n      <Form\n        className={`${baseClass}__form`}\n        isInitializing={isInitializing}\n        onChange={[onChange]}\n        onSubmit={handleSubmit}\n      >\n        <FieldSelect\n          fields={fields}\n          onChange={onFieldSelect}\n          permissions={collectionPermissions.fields}\n        />\n        {selectedFields.length === 0 ? null : (\n          <div className=\"render-fields\">\n            {selectedFields.map((option, i) => {\n              const {\n                value: { field, fieldPermissions, path },\n              } = option;\n\n              return (\n                <RenderField\n                  clientFieldConfig={field}\n                  indexPath=\"\"\n                  key={`${path}-${i}`}\n                  parentPath=\"\"\n                  parentSchemaPath=\"\"\n                  path={path}\n                  permissions={fieldPermissions}\n                />\n              );\n            })}\n          </div>\n        )}\n        <div className={`${baseClass}__sidebar-wrap`}>\n          <div className={`${baseClass}__sidebar`}>\n            <div className={`${baseClass}__sidebar-sticky-wrap`}>\n              <div className={`${baseClass}__document-actions`}>\n                <Button type=\"submit\">{t(\"general:applyChanges\")}</Button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </Form>\n    </div>\n  );\n};\n"],"mappings":"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","ignoreList":[]}