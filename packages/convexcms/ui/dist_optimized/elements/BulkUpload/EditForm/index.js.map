{"version":3,"file":"index.js","names":["React","useCallback","useEffect","useRouter","useSearchParams","formatAdminURL","Form","useForm","WatchChildErrors","useConfig","useDocumentEvents","useDocumentInfo","useEditDepth","OperationProvider","useRouteTransition","useServerFunctions","useUploadEdits","abortAndIgnore","handleAbortRef","useDocumentDrawerContext","DocumentFields","Upload","useFormsManager","BulkUploadProvider","baseClass","EditForm","submitted","action","collectionSlug","docSlug","docPermissions","getDocPreferences","hasSavePermission","initialState","isEditing","isInitializing","CustomUpload","onSave","onSaveFromContext","getFormState","config","routes","admin","adminRoute","getEntityConfig","abortOnChangeRef","useRef","collectionConfig","router","depth","params","reportUpdate","resetUploadEdits","startRouteTransition","locale","get","slug","schemaPath","useState","json","entitySlug","updatedAt","result","Date","toISOString","operation","redirectRoute","path","doc","id","push","onChange","formState","prevFormState","controller","docPreferences","state","newFormState","signal","skipValidation","current","abortOnChange","_jsx","_jsxs","className","disabled","undefined","method","onSuccess","BeforeFields","Fragment","uploadConfig","upload","fields","schemaPathSegments","ReportAllErrors","GetFieldProxy","getFields","getFormDataRef","docConfig","activeIndex","setFormTotalErrorCount","errorCountRef","reportFormErrorCount","errorCount","index","setErrorCount"],"sources":["../../../../src/elements/BulkUpload/EditForm/index.tsx"],"sourcesContent":["\"use client\";\n\nimport React, { useCallback, useEffect } from \"react\";\nimport { useRouter, useSearchParams } from \"next/navigation.js\";\nimport { formatAdminURL } from \"@convexcms/core/shared\";\n\nimport type { EditFormProps } from \"./types.js\";\nimport { Form, useForm } from \"../../../forms/Form/index.js\";\nimport { type FormProps } from \"../../../forms/Form/types.js\";\nimport { WatchChildErrors } from \"../../../forms/WatchChildErrors/index.js\";\nimport { useConfig } from \"../../../providers/Config/index.js\";\nimport { useDocumentEvents } from \"../../../providers/DocumentEvents/index.js\";\nimport { useDocumentInfo } from \"../../../providers/DocumentInfo/index.js\";\nimport { useEditDepth } from \"../../../providers/EditDepth/index.js\";\nimport { OperationProvider } from \"../../../providers/Operation/index.js\";\nimport { useRouteTransition } from \"../../../providers/RouteTransition/index.js\";\nimport { useServerFunctions } from \"../../../providers/ServerFunctions/index.js\";\nimport { useUploadEdits } from \"../../../providers/UploadEdits/index.js\";\nimport {\n  abortAndIgnore,\n  handleAbortRef,\n} from \"../../../utilities/abortAndIgnore.js\";\nimport { useDocumentDrawerContext } from \"../../DocumentDrawer/Provider.js\";\nimport { DocumentFields } from \"../../DocumentFields/index.js\";\nimport { Upload } from \"../../Upload/index.js\";\nimport { useFormsManager } from \"../FormsManager/index.js\";\nimport { BulkUploadProvider } from \"../index.js\";\n\nimport \"./index.scss\";\n\nconst baseClass = \"collection-edit\";\n\n// This component receives props only on _pages_\n// When rendered within a drawer, props are empty\n// This is solely to support custom edit views which get server-rendered\n\nexport function EditForm({ submitted }: EditFormProps) {\n  const {\n    action,\n    collectionSlug: docSlug,\n    docPermissions,\n    getDocPreferences,\n    hasSavePermission,\n    initialState,\n    isEditing,\n    isInitializing,\n    Upload: CustomUpload,\n  } = useDocumentInfo();\n\n  const { onSave: onSaveFromContext } = useDocumentDrawerContext();\n\n  const { getFormState } = useServerFunctions();\n\n  const {\n    config: {\n      routes: { admin: adminRoute },\n    },\n    getEntityConfig,\n  } = useConfig();\n\n  const abortOnChangeRef = React.useRef<AbortController>(null);\n\n  const collectionConfig = getEntityConfig({ collectionSlug: docSlug });\n  const router = useRouter();\n  const depth = useEditDepth();\n  const params = useSearchParams();\n  const { reportUpdate } = useDocumentEvents();\n  const { resetUploadEdits } = useUploadEdits();\n  const { startRouteTransition } = useRouteTransition();\n\n  const locale = params.get(\"locale\");\n\n  const collectionSlug = collectionConfig.slug;\n\n  const [schemaPath] = React.useState(collectionSlug);\n\n  const onSave = useCallback(\n    (json) => {\n      reportUpdate({\n        entitySlug: collectionSlug,\n        updatedAt: json?.result?.updatedAt || new Date().toISOString(),\n      });\n\n      if (typeof onSaveFromContext === \"function\") {\n        void onSaveFromContext({\n          ...json,\n          operation: \"create\",\n        });\n      }\n\n      if (!isEditing && depth < 2) {\n        // Redirect to the same locale if it's been set\n        const redirectRoute = formatAdminURL({\n          adminRoute,\n          path: `/collections/${collectionSlug}/${json?.doc?.id}${locale ? `?locale=${locale}` : \"\"}`,\n        });\n\n        startRouteTransition(() => router.push(redirectRoute));\n      } else {\n        resetUploadEdits();\n      }\n    },\n    [\n      adminRoute,\n      collectionSlug,\n      depth,\n      isEditing,\n      locale,\n      onSaveFromContext,\n      reportUpdate,\n      resetUploadEdits,\n      router,\n      startRouteTransition,\n    ],\n  );\n\n  const onChange: NonNullable<FormProps[\"onChange\"]>[0] = useCallback(\n    async ({ formState: prevFormState, submitted }) => {\n      const controller = handleAbortRef(abortOnChangeRef);\n\n      const docPreferences = await getDocPreferences();\n\n      const { state: newFormState } = await getFormState({\n        collectionSlug,\n        docPermissions,\n        docPreferences,\n        formState: prevFormState,\n        operation: \"create\",\n        schemaPath,\n        signal: controller.signal,\n        skipValidation: !submitted,\n      });\n\n      abortOnChangeRef.current = null;\n\n      return newFormState;\n    },\n    [\n      collectionSlug,\n      schemaPath,\n      getDocPreferences,\n      getFormState,\n      docPermissions,\n    ],\n  );\n\n  useEffect(() => {\n    const abortOnChange = abortOnChangeRef.current;\n\n    return () => {\n      abortAndIgnore(abortOnChange);\n    };\n  }, []);\n\n  return (\n    <OperationProvider operation=\"create\">\n      <BulkUploadProvider>\n        <Form\n          action={action}\n          className={`${baseClass}__form`}\n          disabled={isInitializing || !hasSavePermission}\n          initialState={isInitializing ? undefined : initialState}\n          isInitializing={isInitializing}\n          method=\"POST\"\n          onChange={[onChange]}\n          onSuccess={onSave}\n          submitted={submitted}\n        >\n          <DocumentFields\n            BeforeFields={\n              <React.Fragment>\n                {CustomUpload || (\n                  <Upload\n                    collectionSlug={collectionConfig.slug}\n                    initialState={initialState}\n                    uploadConfig={collectionConfig.upload}\n                  />\n                )}\n              </React.Fragment>\n            }\n            docPermissions={docPermissions}\n            fields={collectionConfig.fields}\n            schemaPathSegments={[collectionConfig.slug]}\n          />\n          <ReportAllErrors />\n          <GetFieldProxy />\n        </Form>\n      </BulkUploadProvider>\n    </OperationProvider>\n  );\n}\n\nfunction GetFieldProxy() {\n  const { getFields } = useForm();\n  const { getFormDataRef } = useFormsManager();\n\n  React.useEffect(() => {\n    getFormDataRef.current = getFields;\n  }, [getFields, getFormDataRef]);\n\n  return null;\n}\n\nfunction ReportAllErrors() {\n  const { docConfig } = useDocumentInfo();\n  const { activeIndex, setFormTotalErrorCount } = useFormsManager();\n  const errorCountRef = React.useRef(0);\n\n  const reportFormErrorCount = React.useCallback(\n    (errorCount) => {\n      if (errorCount === errorCountRef.current) {\n        return;\n      }\n      setFormTotalErrorCount({ errorCount, index: activeIndex });\n      errorCountRef.current = errorCount;\n    },\n    [activeIndex, setFormTotalErrorCount],\n  );\n\n  if (!docConfig) {\n    return null;\n  }\n\n  return (\n    <WatchChildErrors\n      fields={docConfig.fields}\n      path={[]}\n      setErrorCount={reportFormErrorCount}\n    />\n  );\n}\n"],"mappings":"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","ignoreList":[]}