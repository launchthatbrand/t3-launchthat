{"version":3,"file":"index.js","names":["React","Fragment","useCallback","useEffect","useState","getTranslation","PlusIcon","useAuth","useTranslation","Button","useDocumentDrawer","Popup","PopupList","Tooltip","useRelatedCollections","baseClass","AddNewRelation","ButtonFromProps","hasMany","path","relationTo","setValue","unstyled","value","relatedCollections","permissions","show","setShow","selectedCollection","setSelectedCollection","relatedToMany","length","collectionConfig","setCollectionConfig","undefined","popupOpen","setPopupOpen","i18n","t","showTooltip","setShowTooltip","DocumentDrawer","DocumentDrawerToggler","isDrawerOpen","toggleDrawer","collectionSlug","slug","onSave","doc","operation","newValue","Array","isArray","id","isNewValue","some","v","onPopupToggle","state","collections","create","collection","find","label","labels","singular","_jsxs","className","_jsx","filter","Boolean","join","onClick","onMouseEnter","onMouseLeave","button","buttonStyle","tooltip","buttonType","horizontalAlign","onToggleOpen","render","close","closePopup","ButtonGroup","map","relatedCollection","size"],"sources":["../../../src/elements/AddNewRelation/index.tsx"],"sourcesContent":["\"use client\";\n\nimport \"./index.scss\";\n\nimport type { ClientCollectionConfig } from \"@convexcms/core\";\nimport React, { Fragment, useCallback, useEffect, useState } from \"react\";\nimport { getTranslation } from \"@convexcms/translations\";\n\nimport type { Value } from \"../../fields/Relationship/types.js\";\nimport type { DocumentDrawerContextType } from \"../DocumentDrawer/Provider.js\";\nimport type { Props } from \"./types.js\";\nimport { PlusIcon } from \"../../icons/Plus/index.js\";\nimport { useAuth } from \"../../providers/Auth/index.js\";\nimport { useTranslation } from \"../../providers/Translation/index.js\";\nimport { Button } from \"../Button/index.js\";\nimport { useDocumentDrawer } from \"../DocumentDrawer/index.js\";\nimport { Popup } from \"../Popup/index.js\";\nimport * as PopupList from \"../Popup/PopupButtonList/index.js\";\nimport { Tooltip } from \"../Tooltip/index.js\";\nimport { useRelatedCollections } from \"./useRelatedCollections.js\";\n\nconst baseClass = \"relationship-add-new\";\n\nexport const AddNewRelation: React.FC<Props> = ({\n  Button: ButtonFromProps,\n  hasMany,\n  path,\n  relationTo,\n  setValue,\n  unstyled,\n  value,\n}) => {\n  const relatedCollections = useRelatedCollections(relationTo);\n  const { permissions } = useAuth();\n  const [show, setShow] = useState(false);\n  const [selectedCollection, setSelectedCollection] = useState<string>();\n\n  const relatedToMany = relatedCollections.length > 1;\n\n  const [collectionConfig, setCollectionConfig] =\n    useState<ClientCollectionConfig>(() =>\n      !relatedToMany ? relatedCollections[0] : undefined,\n    );\n\n  const [popupOpen, setPopupOpen] = useState(false);\n  const { i18n, t } = useTranslation();\n  const [showTooltip, setShowTooltip] = useState(false);\n\n  const [\n    DocumentDrawer,\n    DocumentDrawerToggler,\n    { isDrawerOpen, toggleDrawer },\n  ] = useDocumentDrawer({\n    collectionSlug: collectionConfig?.slug,\n  });\n\n  const onSave: DocumentDrawerContextType[\"onSave\"] = useCallback(\n    ({ doc, operation }) => {\n      if (operation === \"create\") {\n        const newValue: Value = Array.isArray(relationTo)\n          ? {\n              relationTo: collectionConfig?.slug,\n              value: doc.id,\n            }\n          : doc.id;\n\n        // ensure the value is not already in the array\n        const isNewValue =\n          Array.isArray(relationTo) && Array.isArray(value)\n            ? !value.some(\n                (v) => v && typeof v === \"object\" && v.value === doc.id,\n              )\n            : value !== doc.id;\n\n        if (isNewValue) {\n          // dispatchOptions({\n          //   collection: collectionConfig,\n          //   // TODO: fix this\n          //   // @ts-expect-error-next-line\n          //   type: 'ADD',\n          //   config,\n          //   docs: [doc],\n          //   i18n,\n          //   sort: true,\n          // })\n\n          if (hasMany) {\n            setValue([...(Array.isArray(value) ? value : []), newValue]);\n          } else {\n            setValue(newValue);\n          }\n        }\n\n        setSelectedCollection(undefined);\n      }\n    },\n    [relationTo, collectionConfig, hasMany, setValue, value],\n  );\n\n  const onPopupToggle = useCallback((state) => {\n    setPopupOpen(state);\n  }, []);\n\n  useEffect(() => {\n    if (permissions) {\n      if (relatedCollections.length === 1) {\n        setShow(permissions.collections[relatedCollections[0]?.slug]?.create);\n      } else {\n        setShow(\n          relatedCollections.some(\n            (collection) => permissions.collections[collection?.slug]?.create,\n          ),\n        );\n      }\n    }\n  }, [permissions, relatedCollections]);\n\n  useEffect(() => {\n    if (relatedToMany && selectedCollection) {\n      setCollectionConfig(\n        relatedCollections.find(\n          (collection) => collection?.slug === selectedCollection,\n        ),\n      );\n    }\n  }, [selectedCollection, relatedToMany, relatedCollections]);\n\n  useEffect(() => {\n    if (relatedToMany && collectionConfig) {\n      // the drawer must be rendered on the page before before opening it\n      // this is why 'selectedCollection' is different from 'collectionConfig'\n      toggleDrawer();\n      setSelectedCollection(undefined);\n    }\n  }, [toggleDrawer, relatedToMany, collectionConfig]);\n\n  useEffect(() => {\n    if (relatedToMany && !isDrawerOpen) {\n      setCollectionConfig(undefined);\n    }\n  }, [isDrawerOpen, relatedToMany]);\n\n  const label = t(\"fields:addNewLabel\", {\n    label: getTranslation(relatedCollections[0].labels.singular, i18n),\n  });\n\n  if (show) {\n    return (\n      <div className={baseClass} id={`${path}-add-new`}>\n        {relatedCollections.length === 1 && (\n          <Fragment>\n            <DocumentDrawerToggler\n              className={[\n                `${baseClass}__add-button`,\n                unstyled && `${baseClass}__add-button--unstyled`,\n              ]\n                .filter(Boolean)\n                .join(\" \")}\n              onClick={() => setShowTooltip(false)}\n              onMouseEnter={() => setShowTooltip(true)}\n              onMouseLeave={() => setShowTooltip(false)}\n            >\n              {ButtonFromProps ? (\n                ButtonFromProps\n              ) : (\n                <Fragment>\n                  <Tooltip\n                    className={`${baseClass}__tooltip`}\n                    show={showTooltip}\n                  >\n                    {label}\n                  </Tooltip>\n                  <PlusIcon />\n                </Fragment>\n              )}\n            </DocumentDrawerToggler>\n            <DocumentDrawer onSave={onSave} />\n          </Fragment>\n        )}\n        {relatedCollections.length > 1 && (\n          <Fragment>\n            <Popup\n              button={\n                ButtonFromProps ? (\n                  ButtonFromProps\n                ) : (\n                  <Button\n                    buttonStyle=\"none\"\n                    className={`${baseClass}__add-button`}\n                    tooltip={popupOpen ? undefined : t(\"fields:addNew\")}\n                  >\n                    <PlusIcon />\n                  </Button>\n                )\n              }\n              buttonType=\"custom\"\n              horizontalAlign=\"center\"\n              onToggleOpen={onPopupToggle}\n              render={({ close: closePopup }) => (\n                <PopupList.ButtonGroup>\n                  {relatedCollections.map((relatedCollection) => {\n                    if (\n                      permissions.collections[relatedCollection?.slug].create\n                    ) {\n                      return (\n                        <PopupList.Button\n                          className={`${baseClass}__relation-button--${relatedCollection?.slug}`}\n                          key={relatedCollection?.slug}\n                          onClick={() => {\n                            closePopup();\n                            setSelectedCollection(relatedCollection?.slug);\n                          }}\n                        >\n                          {getTranslation(\n                            relatedCollection?.labels?.singular,\n                            i18n,\n                          )}\n                        </PopupList.Button>\n                      );\n                    }\n\n                    return null;\n                  })}\n                </PopupList.ButtonGroup>\n              )}\n              size=\"medium\"\n            />\n            {collectionConfig &&\n              permissions.collections[collectionConfig?.slug]?.create && (\n                <DocumentDrawer onSave={onSave} />\n              )}\n          </Fragment>\n        )}\n      </div>\n    );\n  }\n  return null;\n};\n"],"mappings":"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","ignoreList":[]}