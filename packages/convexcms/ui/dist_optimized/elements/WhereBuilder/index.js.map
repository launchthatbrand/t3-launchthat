{"version":3,"file":"index.js","names":["React","useMemo","transformWhereQuery","validateWhereQuery","getTranslation","useListQuery","useTranslation","Button","Condition","fieldTypes","reduceFields","baseClass","WhereBuilder","props","collectionPluralLabel","fields","renderedFilters","resolvedFilterOptions","i18n","t","reducedFields","handleWhereChange","query","conditions","whereFromSearch","where","or","transformedWhere","console","warn","JSON","stringify","addCondition","useCallback","andIndex","field","orIndex","relation","newConditions","defaultOperator","type","operators","value","and","splice","undefined","push","updateCondition","operator","incomingOperator","valueArg","existingCondition","defaults","valueChanged","operatorChanged","Object","keys","newRowCondition","removeCondition","length","_jsxs","className","Fragment","_jsx","label","map","compoundOrKey","Array","isArray","_","condition","fieldName","filterOptions","get","RenderedFilter","buttonStyle","icon","iconPosition","iconStyle","onClick","find","admin","disableListFilter"],"sources":["../../../src/elements/WhereBuilder/index.tsx"],"sourcesContent":["\"use client\";\n\nimport \"./index.scss\";\n\nimport type { Operator } from \"@convexcms/core\";\nimport React, { useMemo } from \"react\";\nimport {\n  transformWhereQuery,\n  validateWhereQuery,\n} from \"@convexcms/core/shared\";\nimport { getTranslation } from \"@convexcms/translations\";\n\nimport type {\n  AddCondition,\n  RemoveCondition,\n  UpdateCondition,\n  WhereBuilderProps,\n} from \"./types.js\";\nimport { useListQuery } from \"../../providers/ListQuery/index.js\";\nimport { useTranslation } from \"../../providers/Translation/index.js\";\nimport { Button } from \"../Button/index.js\";\nimport { Condition } from \"./Condition/index.js\";\nimport fieldTypes from \"./field-types.js\";\nimport { reduceFields } from \"./reduceFields.js\";\n\nconst baseClass = \"where-builder\";\n\nexport { WhereBuilderProps };\n\n/**\n * The WhereBuilder component is used to render the filter controls for a collection's list view.\n * It is part of the {@link ListControls} component which is used to render the controls (search, filter, where).\n */\nexport const WhereBuilder: React.FC<WhereBuilderProps> = (props) => {\n  const {\n    collectionPluralLabel,\n    fields,\n    renderedFilters,\n    resolvedFilterOptions,\n  } = props;\n  const { i18n, t } = useTranslation();\n\n  const reducedFields = useMemo(\n    () => reduceFields({ fields, i18n }),\n    [fields, i18n],\n  );\n\n  const { handleWhereChange, query } = useListQuery();\n\n  const conditions = useMemo(() => {\n    const whereFromSearch = query.where;\n\n    if (whereFromSearch) {\n      if (validateWhereQuery(whereFromSearch)) {\n        return whereFromSearch.or;\n      }\n\n      // Transform the where query to be in the right format. This will transform something simple like [text][equals]=example%20post to the right format\n      const transformedWhere = transformWhereQuery(whereFromSearch);\n\n      if (validateWhereQuery(transformedWhere)) {\n        return transformedWhere.or;\n      }\n\n      console.warn(\n        `Invalid where query in URL: ${JSON.stringify(whereFromSearch)}`,\n      ); // eslint-disable-line no-console\n    }\n\n    return [];\n  }, [query.where]);\n\n  const addCondition: AddCondition = React.useCallback(\n    async ({ andIndex, field, orIndex, relation }) => {\n      const newConditions = [...conditions];\n\n      const defaultOperator = fieldTypes[field.field.type].operators[0].value;\n\n      if (relation === \"and\") {\n        newConditions[orIndex].and.splice(andIndex, 0, {\n          [field.value]: {\n            [defaultOperator]: undefined,\n          },\n        });\n      } else {\n        newConditions.push({\n          and: [\n            {\n              [field.value]: {\n                [defaultOperator]: undefined,\n              },\n            },\n          ],\n        });\n      }\n\n      await handleWhereChange({ or: newConditions });\n    },\n    [conditions, handleWhereChange],\n  );\n\n  const updateCondition: UpdateCondition = React.useCallback(\n    async ({\n      andIndex,\n      field,\n      operator: incomingOperator,\n      orIndex,\n      value: valueArg,\n    }) => {\n      const existingCondition = conditions[orIndex].and[andIndex];\n\n      const defaults = fieldTypes[field.field.type];\n      const operator = incomingOperator || defaults.operators[0].value;\n\n      if (typeof existingCondition === \"object\" && field.value) {\n        const value = valueArg ?? existingCondition?.[operator];\n\n        const valueChanged =\n          value !== existingCondition?.[field.value]?.[operator];\n\n        const operatorChanged =\n          operator !== Object.keys(existingCondition?.[field.value] || {})?.[0];\n\n        if (valueChanged || operatorChanged) {\n          const newRowCondition = {\n            [field.value]: { [operator]: value },\n          };\n\n          const newConditions = [...conditions];\n          newConditions[orIndex].and[andIndex] = newRowCondition;\n\n          await handleWhereChange({ or: newConditions });\n        }\n      }\n    },\n    [conditions, handleWhereChange],\n  );\n\n  const removeCondition: RemoveCondition = React.useCallback(\n    async ({ andIndex, orIndex }) => {\n      const newConditions = [...conditions];\n      newConditions[orIndex].and.splice(andIndex, 1);\n\n      if (newConditions[orIndex].and.length === 0) {\n        newConditions.splice(orIndex, 1);\n      }\n\n      await handleWhereChange({ or: newConditions });\n    },\n    [conditions, handleWhereChange],\n  );\n\n  return (\n    <div className={baseClass}>\n      {conditions.length > 0 && (\n        <React.Fragment>\n          <div className={`${baseClass}__label`}>\n            {t(\"general:filterWhere\", {\n              label: getTranslation(collectionPluralLabel, i18n),\n            })}\n          </div>\n          <ul className={`${baseClass}__or-filters`}>\n            {conditions.map((or, orIndex) => {\n              const compoundOrKey = `${orIndex}_${Array.isArray(or?.and) ? or.and.length : \"\"}`;\n\n              return (\n                <li key={compoundOrKey}>\n                  {orIndex !== 0 && (\n                    <div className={`${baseClass}__label`}>\n                      {t(\"general:or\")}\n                    </div>\n                  )}\n                  <ul className={`${baseClass}__and-filters`}>\n                    {Array.isArray(or?.and) &&\n                      or.and.map((_, andIndex) => {\n                        const condition = conditions[orIndex].and[andIndex];\n                        const fieldName = Object.keys(condition)[0];\n\n                        const operator =\n                          (Object.keys(\n                            condition?.[fieldName] || {},\n                          )?.[0] as Operator) || undefined;\n\n                        const value =\n                          condition?.[fieldName]?.[operator] || undefined;\n\n                        return (\n                          <li key={andIndex}>\n                            {andIndex !== 0 && (\n                              <div className={`${baseClass}__label`}>\n                                {t(\"general:and\")}\n                              </div>\n                            )}\n                            <Condition\n                              addCondition={addCondition}\n                              andIndex={andIndex}\n                              fieldName={fieldName}\n                              filterOptions={resolvedFilterOptions?.get(\n                                fieldName,\n                              )}\n                              operator={operator}\n                              orIndex={orIndex}\n                              reducedFields={reducedFields}\n                              removeCondition={removeCondition}\n                              RenderedFilter={renderedFilters?.get(fieldName)}\n                              updateCondition={updateCondition}\n                              value={value}\n                            />\n                          </li>\n                        );\n                      })}\n                  </ul>\n                </li>\n              );\n            })}\n          </ul>\n          <Button\n            buttonStyle=\"icon-label\"\n            className={`${baseClass}__add-or`}\n            icon=\"plus\"\n            iconPosition=\"left\"\n            iconStyle=\"with-border\"\n            onClick={async () => {\n              await addCondition({\n                andIndex: 0,\n                field: reducedFields[0],\n                orIndex: conditions.length,\n                relation: \"or\",\n              });\n            }}\n          >\n            {t(\"general:or\")}\n          </Button>\n        </React.Fragment>\n      )}\n      {conditions.length === 0 && (\n        <div className={`${baseClass}__no-filters`}>\n          <div className={`${baseClass}__label`}>\n            {t(\"general:noFiltersSet\")}\n          </div>\n          <Button\n            buttonStyle=\"icon-label\"\n            className={`${baseClass}__add-first-filter`}\n            icon=\"plus\"\n            iconPosition=\"left\"\n            iconStyle=\"with-border\"\n            onClick={async () => {\n              if (reducedFields.length > 0) {\n                await addCondition({\n                  andIndex: 0,\n                  field: reducedFields.find(\n                    (field) => !field.field.admin?.disableListFilter,\n                  ),\n                  orIndex: conditions.length,\n                  relation: \"or\",\n                });\n              }\n            }}\n          >\n            {t(\"general:addFilter\")}\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n};\n"],"mappings":"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","ignoreList":[]}