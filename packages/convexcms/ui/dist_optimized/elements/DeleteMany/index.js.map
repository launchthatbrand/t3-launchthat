{"version":3,"file":"index.js","names":["React","useCallback","useRouter","useSearchParams","mergeListSearchAndWhere","getTranslation","useModal","qs","toast","useAuth","useConfig","useRouteCache","SelectAllStatus","useSelection","useTranslation","requests","ConfirmationModal","baseClass","DeleteMany","props","collection","slug","labels","plural","singular","permissions","config","routes","api","serverURL","openModal","count","getQueryParams","selectAll","toggleAll","i18n","t","router","searchParams","clearRouteCache","collectionPermissions","collections","hasDeletePermission","delete","modalSlug","addDefaultError","error","handleDelete","queryWithSearch","collectionConfig","search","get","queryString","headers","language","then","res","json","deletedDocs","docs","length","successLabel","status","success","label","errors","message","description","map","join","replace","stringify","page","undefined","addQueryPrefix","_err","None","_jsxs","Fragment","_jsx","className","onClick","type","body","confirmingLabel","heading","onConfirm"],"sources":["../../../src/elements/DeleteMany/index.tsx"],"sourcesContent":["\"use client\";\n\nimport \"./index.scss\";\n\nimport type { ClientCollectionConfig } from \"@convexcms/core\";\nimport React, { useCallback } from \"react\";\nimport { useRouter, useSearchParams } from \"next/navigation.js\";\nimport { mergeListSearchAndWhere } from \"@convexcms/core/shared\";\nimport { getTranslation } from \"@convexcms/translations\";\nimport { useModal } from \"@faceless-ui/modal\";\nimport * as qs from \"qs-esm\";\nimport { toast } from \"sonner\";\n\nimport { useAuth } from \"../../providers/Auth/index.js\";\nimport { useConfig } from \"../../providers/Config/index.js\";\nimport { useRouteCache } from \"../../providers/RouteCache/index.js\";\nimport {\n  SelectAllStatus,\n  useSelection,\n} from \"../../providers/Selection/index.js\";\nimport { useTranslation } from \"../../providers/Translation/index.js\";\nimport { requests } from \"../../utilities/api.js\";\nimport { ConfirmationModal } from \"../ConfirmationModal/index.js\";\n\nconst baseClass = \"delete-documents\";\n\nexport type Props = {\n  collection: ClientCollectionConfig;\n  title?: string;\n};\n\nexport const DeleteMany: React.FC<Props> = (props) => {\n  const {\n    collection,\n    collection: { slug, labels: { plural, singular } } = {},\n  } = props;\n\n  const { permissions } = useAuth();\n  const {\n    config: {\n      routes: { api },\n      serverURL,\n    },\n  } = useConfig();\n  const { openModal } = useModal();\n  const { count, getQueryParams, selectAll, toggleAll } = useSelection();\n  const { i18n, t } = useTranslation();\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const { clearRouteCache } = useRouteCache();\n\n  const collectionPermissions = permissions?.collections?.[slug];\n  const hasDeletePermission = collectionPermissions?.delete;\n\n  const modalSlug = `delete-${slug}`;\n\n  const addDefaultError = useCallback(() => {\n    toast.error(t(\"error:unknown\"));\n  }, [t]);\n\n  const handleDelete = useCallback(async () => {\n    const queryWithSearch = mergeListSearchAndWhere({\n      collectionConfig: collection,\n      search: searchParams.get(\"search\"),\n    });\n\n    const queryString = getQueryParams(queryWithSearch);\n\n    await requests\n      .delete(`${serverURL}${api}/${slug}${queryString}`, {\n        headers: {\n          \"Accept-Language\": i18n.language,\n          \"Content-Type\": \"application/json\",\n        },\n      })\n      .then(async (res) => {\n        try {\n          const json = await res.json();\n\n          const deletedDocs = json?.docs.length || 0;\n          const successLabel = deletedDocs > 1 ? plural : singular;\n\n          if (res.status < 400 || deletedDocs > 0) {\n            toast.success(\n              t(\"general:deletedCountSuccessfully\", {\n                count: deletedDocs,\n                label: getTranslation(successLabel, i18n),\n              }),\n            );\n\n            if (json?.errors.length > 0) {\n              toast.error(json.message, {\n                description: json.errors\n                  .map((error) => error.message)\n                  .join(\"\\n\"),\n              });\n            }\n\n            toggleAll();\n\n            router.replace(\n              qs.stringify(\n                {\n                  page: selectAll ? \"1\" : undefined,\n                },\n                { addQueryPrefix: true },\n              ),\n            );\n\n            clearRouteCache();\n\n            return null;\n          }\n\n          if (json.errors) {\n            toast.error(json.message, {\n              description: json.errors.map((error) => error.message).join(\"\\n\"),\n            });\n          } else {\n            return addDefaultError();\n          }\n          return false;\n        } catch (_err) {\n          return addDefaultError();\n        }\n      });\n  }, [\n    searchParams,\n    addDefaultError,\n    api,\n    getQueryParams,\n    i18n,\n    plural,\n    router,\n    selectAll,\n    serverURL,\n    singular,\n    slug,\n    t,\n    toggleAll,\n    clearRouteCache,\n    collection,\n  ]);\n\n  if (selectAll === SelectAllStatus.None || !hasDeletePermission) {\n    return null;\n  }\n\n  return (\n    <React.Fragment>\n      <button\n        className={`${baseClass}__toggle`}\n        onClick={() => {\n          openModal(modalSlug);\n        }}\n        type=\"button\"\n      >\n        {t(\"general:delete\")}\n      </button>\n      <ConfirmationModal\n        body={t(\"general:aboutToDeleteCount\", {\n          count,\n          label: getTranslation(count > 1 ? plural : singular, i18n),\n        })}\n        confirmingLabel={t(\"general:deleting\")}\n        heading={t(\"general:confirmDeletion\")}\n        modalSlug={modalSlug}\n        onConfirm={handleDelete}\n      />\n    </React.Fragment>\n  );\n};\n"],"mappings":"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","ignoreList":[]}