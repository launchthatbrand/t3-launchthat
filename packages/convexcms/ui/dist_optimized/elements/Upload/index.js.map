{"version":3,"file":"index.js","names":["React","Fragment","useCallback","useEffect","useRef","useState","isImage","toast","FieldError","fieldBaseClass","useForm","useFormProcessing","useField","useConfig","useDocumentInfo","EditDepthProvider","useTranslation","useUploadEdits","Button","Drawer","DrawerToggler","Dropzone","EditUpload","FileDetails","PreviewSizes","Thumbnail","baseClass","editDrawerSlug","sizePreviewSlug","validate","value","undefined","UploadActions","customActions","enableAdjustments","enablePreviewSizes","mimeType","t","fileTypeIsAdjustable","length","_jsxs","className","_jsx","slug","map","CustomAction","i","Upload","props","collectionSlug","initialState","onChange","uploadConfig","config","routes","api","serverURL","setModified","resetUploadEdits","updateUploadEdits","uploadEdits","id","docPermissions","savedDocumentData","setUploadStatus","isFormSubmitting","errorMessage","setValue","showError","path","fileSrc","setFileSrc","removedFile","setRemovedFile","filename","setFilename","name","showUrlInput","setShowUrlInput","fileUrl","setFileUrl","urlInputRef","inputRef","useServerSideFetch","pasteURL","allowList","handleFileChange","newFile","File","URL","createObjectURL","renameFile","fileToChange","newName","type","lastModified","handleFileNameChange","e","updatedFileName","target","handleFileSelection","files","fileToUpload","handleFileRemoval","onEditsSave","args","handleUrlSubmit","clientResponse","fetch","ok","Error","status","blob","fileName","decodeURIComponent","split","pop","file","_clientError","error","encodeURIComponent","serverResponse","_serverError","current","canRemoveUpload","update","delete","hasImageSizes","imageSizes","hasResizeOptions","Boolean","resizeOptions","focalPointEnabled","focalPoint","crop","showCrop","showFocalPoint","acceptMimeTypes","mimeTypes","join","imageCacheTag","cacheTags","updatedAt","hideFileInputOnCreate","filter","message","customUploadActions","doc","handleRemove","hideRemoveFile","buttonStyle","onClick","click","size","accept","hidden","ref","icon","iconStyle","round","tooltip","Header","url","initialCrop","initialFocalPoint","x","focalX","y","focalY","onSave","hoverTitle","title","label"],"sources":["../../../src/elements/Upload/index.tsx"],"sourcesContent":["\"use client\";\n\nimport \"./index.scss\";\n\nimport type {\n  FormState,\n  SanitizedCollectionConfig,\n  UploadEdits,\n} from \"@convexcms/core\";\nimport React, {\n  Fragment,\n  useCallback,\n  useEffect,\n  useRef,\n  useState,\n} from \"react\";\nimport { isImage } from \"@convexcms/core/shared\";\nimport { toast } from \"sonner\";\n\nimport { FieldError } from \"../../fields/FieldError/index.js\";\nimport { fieldBaseClass } from \"../../fields/shared/index.js\";\nimport { useForm, useFormProcessing } from \"../../forms/Form/index.js\";\nimport { useField } from \"../../forms/useField/index.js\";\nimport { useConfig } from \"../../providers/Config/index.js\";\nimport { useDocumentInfo } from \"../../providers/DocumentInfo/index.js\";\nimport { EditDepthProvider } from \"../../providers/EditDepth/index.js\";\nimport { useTranslation } from \"../../providers/Translation/index.js\";\nimport { useUploadEdits } from \"../../providers/UploadEdits/index.js\";\nimport { Button } from \"../Button/index.js\";\nimport { Drawer, DrawerToggler } from \"../Drawer/index.js\";\nimport { Dropzone } from \"../Dropzone/index.js\";\nimport { EditUpload } from \"../EditUpload/index.js\";\nimport { FileDetails } from \"../FileDetails/index.js\";\nimport { PreviewSizes } from \"../PreviewSizes/index.js\";\nimport { Thumbnail } from \"../Thumbnail/index.js\";\n\nconst baseClass = \"file-field\";\nexport const editDrawerSlug = \"edit-upload\";\nexport const sizePreviewSlug = \"preview-sizes\";\n\nconst validate = (value) => {\n  if (!value && value !== undefined) {\n    return \"A file is required.\";\n  }\n\n  return true;\n};\n\ntype UploadActionsArgs = {\n  readonly customActions?: React.ReactNode[];\n  readonly enableAdjustments: boolean;\n  readonly enablePreviewSizes: boolean;\n  readonly mimeType: string;\n};\n\nexport const UploadActions = ({\n  customActions,\n  enableAdjustments,\n  enablePreviewSizes,\n  mimeType,\n}: UploadActionsArgs) => {\n  const { t } = useTranslation();\n\n  const fileTypeIsAdjustable =\n    isImage(mimeType) &&\n    mimeType !== \"image/svg+xml\" &&\n    mimeType !== \"image/jxl\";\n\n  if (!fileTypeIsAdjustable && (!customActions || customActions.length === 0)) {\n    return null;\n  }\n\n  return (\n    <div className={`${baseClass}__upload-actions`}>\n      {fileTypeIsAdjustable && (\n        <React.Fragment>\n          {enablePreviewSizes && (\n            <DrawerToggler\n              className={`${baseClass}__previewSizes`}\n              slug={sizePreviewSlug}\n            >\n              {t(\"upload:previewSizes\")}\n            </DrawerToggler>\n          )}\n          {enableAdjustments && (\n            <DrawerToggler\n              className={`${baseClass}__edit`}\n              slug={editDrawerSlug}\n            >\n              {t(\"upload:editImage\")}\n            </DrawerToggler>\n          )}\n        </React.Fragment>\n      )}\n\n      {customActions &&\n        customActions.map((CustomAction, i) => {\n          return <React.Fragment key={i}>{CustomAction}</React.Fragment>;\n        })}\n    </div>\n  );\n};\n\nexport type UploadProps = {\n  readonly collectionSlug: string;\n  readonly customActions?: React.ReactNode[];\n  readonly initialState?: FormState;\n  readonly onChange?: (file?: File) => void;\n  readonly uploadConfig: SanitizedCollectionConfig[\"upload\"];\n};\n\nexport const Upload: React.FC<UploadProps> = (props) => {\n  const {\n    collectionSlug,\n    customActions,\n    initialState,\n    onChange,\n    uploadConfig,\n  } = props;\n\n  const {\n    config: {\n      routes: { api },\n      serverURL,\n    },\n  } = useConfig();\n\n  const { t } = useTranslation();\n  const { setModified } = useForm();\n  const { resetUploadEdits, updateUploadEdits, uploadEdits } = useUploadEdits();\n  const { id, docPermissions, savedDocumentData, setUploadStatus } =\n    useDocumentInfo();\n  const isFormSubmitting = useFormProcessing();\n  const { errorMessage, setValue, showError, value } = useField<File>({\n    path: \"file\",\n    validate,\n  });\n\n  const [fileSrc, setFileSrc] = useState<null | string>(null);\n  const [removedFile, setRemovedFile] = useState(false);\n  const [filename, setFilename] = useState<string>(value?.name || \"\");\n  const [showUrlInput, setShowUrlInput] = useState(false);\n  const [fileUrl, setFileUrl] = useState<string>(\"\");\n\n  const urlInputRef = useRef<HTMLInputElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  const useServerSideFetch =\n    typeof uploadConfig?.pasteURL === \"object\" &&\n    uploadConfig.pasteURL.allowList?.length > 0;\n\n  const handleFileChange = useCallback(\n    (newFile: File) => {\n      if (newFile instanceof File) {\n        setFileSrc(URL.createObjectURL(newFile));\n      }\n\n      setValue(newFile);\n      setShowUrlInput(false);\n\n      if (typeof onChange === \"function\") {\n        onChange(newFile);\n      }\n    },\n    [onChange, setValue],\n  );\n\n  const renameFile = (fileToChange: File, newName: string): File => {\n    // Creating a new File object with updated properties\n    const newFile = new File([fileToChange], newName, {\n      type: fileToChange.type,\n      lastModified: fileToChange.lastModified,\n    });\n    return newFile;\n  };\n\n  const handleFileNameChange = React.useCallback(\n    (e: React.ChangeEvent<HTMLInputElement>) => {\n      const updatedFileName = e.target.value;\n\n      if (value) {\n        handleFileChange(renameFile(value, updatedFileName));\n        setFilename(updatedFileName);\n      }\n    },\n    [handleFileChange, value],\n  );\n\n  const handleFileSelection = useCallback(\n    (files: FileList) => {\n      const fileToUpload = files?.[0];\n      handleFileChange(fileToUpload);\n    },\n    [handleFileChange],\n  );\n\n  const handleFileRemoval = useCallback(() => {\n    setRemovedFile(true);\n    handleFileChange(null);\n    setFileSrc(\"\");\n    setFileUrl(\"\");\n    resetUploadEdits();\n    setShowUrlInput(false);\n  }, [handleFileChange, resetUploadEdits]);\n\n  const onEditsSave = useCallback(\n    (args: UploadEdits) => {\n      setModified(true);\n      updateUploadEdits(args);\n    },\n    [setModified, updateUploadEdits],\n  );\n\n  const handleUrlSubmit = async () => {\n    if (!fileUrl || uploadConfig?.pasteURL === false) {\n      return;\n    }\n\n    setUploadStatus(\"uploading\");\n    try {\n      // Attempt client-side fetch\n      const clientResponse = await fetch(fileUrl);\n\n      if (!clientResponse.ok) {\n        throw new Error(`Fetch failed with status: ${clientResponse.status}`);\n      }\n\n      const blob = await clientResponse.blob();\n      const fileName = decodeURIComponent(fileUrl.split(\"/\").pop() || \"\");\n      const file = new File([blob], fileName, { type: blob.type });\n\n      handleFileChange(file);\n      setUploadStatus(\"idle\");\n      return; // Exit if client-side fetch succeeds\n    } catch (_clientError) {\n      if (!useServerSideFetch) {\n        // If server-side fetch is not enabled, show client-side error\n        toast.error(\"Failed to fetch the file.\");\n        setUploadStatus(\"failed\");\n        return;\n      }\n    }\n\n    // Attempt server-side fetch if client-side fetch fails and useServerSideFetch is true\n    try {\n      const pasteURL = `/${collectionSlug}/paste-url${id ? `/${id}?` : \"?\"}src=${encodeURIComponent(fileUrl)}`;\n      const serverResponse = await fetch(`${serverURL}${api}${pasteURL}`);\n\n      if (!serverResponse.ok) {\n        throw new Error(`Fetch failed with status: ${serverResponse.status}`);\n      }\n\n      const blob = await serverResponse.blob();\n      const fileName = decodeURIComponent(fileUrl.split(\"/\").pop() || \"\");\n      const file = new File([blob], fileName, { type: blob.type });\n\n      handleFileChange(file);\n      setUploadStatus(\"idle\");\n    } catch (_serverError) {\n      toast.error(\"The provided URL is not allowed.\");\n      setUploadStatus(\"failed\");\n    }\n  };\n\n  useEffect(() => {\n    if (initialState?.file?.value instanceof File) {\n      setFileSrc(URL.createObjectURL(initialState.file.value));\n      setRemovedFile(false);\n    }\n  }, [initialState]);\n\n  useEffect(() => {\n    if (showUrlInput && urlInputRef.current) {\n      // urlInputRef.current.focus() // Focus on the remote-url input field when showUrlInput is true\n    }\n  }, [showUrlInput]);\n\n  useEffect(() => {\n    if (isFormSubmitting) {\n      setRemovedFile(false);\n    }\n  }, [isFormSubmitting]);\n\n  const canRemoveUpload =\n    docPermissions?.update &&\n    \"delete\" in docPermissions &&\n    docPermissions?.delete;\n\n  const hasImageSizes = uploadConfig?.imageSizes?.length > 0;\n  const hasResizeOptions = Boolean(uploadConfig?.resizeOptions);\n  // Explicity check if set to true, default is undefined\n  const focalPointEnabled = uploadConfig?.focalPoint === true;\n\n  const { crop: showCrop = true, focalPoint = true } = uploadConfig;\n\n  const showFocalPoint =\n    focalPoint && (hasImageSizes || hasResizeOptions || focalPointEnabled);\n\n  const acceptMimeTypes = uploadConfig.mimeTypes?.join(\", \");\n\n  const imageCacheTag = uploadConfig?.cacheTags && savedDocumentData?.updatedAt;\n\n  if (uploadConfig.hideFileInputOnCreate && !savedDocumentData?.filename) {\n    return null;\n  }\n\n  return (\n    <div className={[fieldBaseClass, baseClass].filter(Boolean).join(\" \")}>\n      <FieldError message={errorMessage} showError={showError} />\n      {savedDocumentData && savedDocumentData.filename && !removedFile && (\n        <FileDetails\n          collectionSlug={collectionSlug}\n          customUploadActions={customActions}\n          doc={savedDocumentData}\n          enableAdjustments={showCrop || showFocalPoint}\n          handleRemove={canRemoveUpload ? handleFileRemoval : undefined}\n          hasImageSizes={hasImageSizes}\n          hideRemoveFile={uploadConfig.hideRemoveFile}\n          imageCacheTag={imageCacheTag}\n          uploadConfig={uploadConfig}\n        />\n      )}\n      {((!uploadConfig.hideFileInputOnCreate && !savedDocumentData?.filename) ||\n        removedFile) && (\n        <div className={`${baseClass}__upload`}>\n          {!value && !showUrlInput && (\n            <Dropzone onChange={handleFileSelection}>\n              <div className={`${baseClass}__dropzoneContent`}>\n                <div className={`${baseClass}__dropzoneButtons`}>\n                  <Button\n                    buttonStyle=\"pill\"\n                    onClick={() => {\n                      if (inputRef.current) {\n                        inputRef.current.click();\n                      }\n                    }}\n                    size=\"small\"\n                  >\n                    {t(\"upload:selectFile\")}\n                  </Button>\n                  <input\n                    accept={acceptMimeTypes}\n                    aria-hidden=\"true\"\n                    className={`${baseClass}__hidden-input`}\n                    hidden\n                    onChange={(e) => {\n                      if (e.target.files && e.target.files.length > 0) {\n                        handleFileSelection(e.target.files);\n                      }\n                    }}\n                    ref={inputRef}\n                    type=\"file\"\n                  />\n                  {uploadConfig?.pasteURL !== false && (\n                    <Fragment>\n                      <span className={`${baseClass}__orText`}>\n                        {t(\"general:or\")}\n                      </span>\n                      <Button\n                        buttonStyle=\"pill\"\n                        onClick={() => {\n                          setShowUrlInput(true);\n                        }}\n                        size=\"small\"\n                      >\n                        {t(\"upload:pasteURL\")}\n                      </Button>\n                    </Fragment>\n                  )}\n                </div>\n\n                <p className={`${baseClass}__dragAndDropText`}>\n                  {t(\"general:or\")} {t(\"upload:dragAndDrop\")}\n                </p>\n              </div>\n            </Dropzone>\n          )}\n          {showUrlInput && (\n            <React.Fragment>\n              <div className={`${baseClass}__remote-file-wrap`}>\n                {/* eslint-disable-next-line jsx-a11y/control-has-associated-label */}\n                <input\n                  className={`${baseClass}__remote-file`}\n                  onChange={(e) => {\n                    setFileUrl(e.target.value);\n                  }}\n                  ref={urlInputRef}\n                  type=\"text\"\n                  value={fileUrl}\n                />\n                <div className={`${baseClass}__add-file-wrap`}>\n                  <button\n                    className={`${baseClass}__add-file`}\n                    onClick={() => {\n                      void handleUrlSubmit();\n                    }}\n                    type=\"button\"\n                  >\n                    {t(\"upload:addFile\")}\n                  </button>\n                </div>\n              </div>\n              <Button\n                buttonStyle=\"icon-label\"\n                className={`${baseClass}__remove`}\n                icon=\"x\"\n                iconStyle=\"with-border\"\n                onClick={() => {\n                  setShowUrlInput(false);\n                }}\n                round\n                tooltip={t(\"general:cancel\")}\n              />\n            </React.Fragment>\n          )}\n          {value && fileSrc && (\n            <React.Fragment>\n              <div className={`${baseClass}__thumbnail-wrap`}>\n                <Thumbnail\n                  collectionSlug={collectionSlug}\n                  fileSrc={isImage(value.type) ? fileSrc : null}\n                />\n              </div>\n              <div className={`${baseClass}__file-adjustments`}>\n                {/* eslint-disable-next-line jsx-a11y/control-has-associated-label */}\n                <input\n                  className={`${baseClass}__filename`}\n                  onChange={handleFileNameChange}\n                  type=\"text\"\n                  value={filename || value.name}\n                />\n                <UploadActions\n                  customActions={customActions}\n                  enableAdjustments={showCrop || showFocalPoint}\n                  enablePreviewSizes={\n                    hasImageSizes && savedDocumentData?.filename && !removedFile\n                  }\n                  mimeType={value.type}\n                />\n              </div>\n              <Button\n                buttonStyle=\"icon-label\"\n                className={`${baseClass}__remove`}\n                icon=\"x\"\n                iconStyle=\"with-border\"\n                onClick={handleFileRemoval}\n                round\n                tooltip={t(\"general:cancel\")}\n              />\n            </React.Fragment>\n          )}\n        </div>\n      )}\n      {(value || savedDocumentData?.filename) && (\n        <EditDepthProvider>\n          <Drawer Header={null} slug={editDrawerSlug}>\n            <EditUpload\n              fileName={value?.name || savedDocumentData?.filename}\n              fileSrc={savedDocumentData?.url || fileSrc}\n              imageCacheTag={imageCacheTag}\n              initialCrop={uploadEdits?.crop ?? undefined}\n              initialFocalPoint={{\n                x:\n                  uploadEdits?.focalPoint?.x || savedDocumentData?.focalX || 50,\n                y:\n                  uploadEdits?.focalPoint?.y || savedDocumentData?.focalY || 50,\n              }}\n              onSave={onEditsSave}\n              showCrop={showCrop}\n              showFocalPoint={showFocalPoint}\n            />\n          </Drawer>\n        </EditDepthProvider>\n      )}\n      {savedDocumentData && hasImageSizes && (\n        <Drawer\n          className={`${baseClass}__previewDrawer`}\n          hoverTitle\n          slug={sizePreviewSlug}\n          title={t(\"upload:sizesFor\", { label: savedDocumentData.filename })}\n        >\n          <PreviewSizes\n            doc={savedDocumentData}\n            imageCacheTag={imageCacheTag}\n            uploadConfig={uploadConfig}\n          />\n        </Drawer>\n      )}\n    </div>\n  );\n};\n"],"mappings":"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","ignoreList":[]}