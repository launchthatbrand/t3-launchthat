{"version":3,"file":"useGetDocPermissions.js","names":["React","qs","hasSavePermission","getHasSavePermission","isEditing","getIsEditing","useGetDocPermissions","id","api","collectionSlug","globalSlug","i18n","locale","permissions","serverURL","setDocPermissions","setHasPublishPermission","setHasSavePermission","useCallback","data","params","undefined","idToUse","newIsEditing","docAccessURL","res","fetch","stringify","body","JSON","_status","credentials","headers","language","method","json","publishedAccessJSON","then","docPermissions","update","newDocPermissions","collections","globals"],"sources":["../../../src/providers/DocumentInfo/useGetDocPermissions.tsx"],"sourcesContent":["import type {\n  Data,\n  SanitizedDocumentPermissions,\n  SanitizedPermissions,\n} from \"@convexcms/core\";\nimport React from \"react\";\nimport * as qs from \"qs-esm\";\n\nimport { hasSavePermission as getHasSavePermission } from \"../../utilities/hasSavePermission.js\";\nimport { isEditing as getIsEditing } from \"../../utilities/isEditing.js\";\n\nexport const useGetDocPermissions = ({\n  id,\n  api,\n  collectionSlug,\n  globalSlug,\n  i18n,\n  locale,\n  permissions,\n  serverURL,\n  setDocPermissions,\n  setHasPublishPermission,\n  setHasSavePermission,\n}: {\n  api: string;\n  collectionSlug: string;\n  globalSlug: string;\n  i18n: any;\n  id: string;\n  locale: string;\n  permissions: SanitizedPermissions;\n  serverURL: string;\n  setDocPermissions: React.Dispatch<\n    React.SetStateAction<SanitizedDocumentPermissions>\n  >;\n  setHasPublishPermission: React.Dispatch<React.SetStateAction<boolean>>;\n  setHasSavePermission: React.Dispatch<React.SetStateAction<boolean>>;\n}) =>\n  React.useCallback(\n    async (data: Data) => {\n      const params = {\n        locale: locale || undefined,\n      };\n\n      const idToUse = data?.id || id;\n      const newIsEditing = getIsEditing({\n        id: idToUse,\n        collectionSlug,\n        globalSlug,\n      });\n\n      if (newIsEditing) {\n        const docAccessURL = collectionSlug\n          ? `/${collectionSlug}/access/${idToUse}`\n          : globalSlug\n            ? `/globals/${globalSlug}/access`\n            : null;\n\n        if (docAccessURL) {\n          const res = await fetch(\n            `${serverURL}${api}${docAccessURL}?${qs.stringify(params)}`,\n            {\n              body: JSON.stringify({\n                ...(data || {}),\n                _status: \"draft\",\n              }),\n              credentials: \"include\",\n              headers: {\n                \"Accept-Language\": i18n.language,\n                \"Content-Type\": \"application/json\",\n              },\n              method: \"post\",\n            },\n          );\n\n          const json: SanitizedDocumentPermissions = await res.json();\n\n          const publishedAccessJSON = await fetch(\n            `${serverURL}${api}${docAccessURL}?${qs.stringify(params)}`,\n            {\n              body: JSON.stringify({\n                ...(data || {}),\n                _status: \"published\",\n              }),\n              credentials: \"include\",\n              headers: {\n                \"Accept-Language\": i18n.language,\n                \"Content-Type\": \"application/json\",\n              },\n              method: \"POST\",\n            },\n          ).then((res) => res.json());\n\n          setDocPermissions(json);\n\n          setHasSavePermission(\n            getHasSavePermission({\n              collectionSlug,\n              docPermissions: json,\n              globalSlug,\n              isEditing: newIsEditing,\n            }),\n          );\n\n          setHasPublishPermission(publishedAccessJSON?.update);\n        }\n      } else {\n        // when creating new documents, there is no permissions saved for this document yet\n        // use the generic entity permissions instead\n        const newDocPermissions = collectionSlug\n          ? permissions?.collections?.[collectionSlug]\n          : permissions?.globals?.[globalSlug];\n\n        setDocPermissions(newDocPermissions);\n\n        setHasSavePermission(\n          getHasSavePermission({\n            collectionSlug,\n            docPermissions: newDocPermissions,\n            globalSlug,\n            isEditing: newIsEditing,\n          }),\n        );\n      }\n    },\n    [\n      serverURL,\n      api,\n      id,\n      permissions,\n      i18n.language,\n      locale,\n      collectionSlug,\n      globalSlug,\n    ],\n  );\n"],"mappings":"AAKA,OAAOA,KAAA,MAAW;AAClB,YAAYC,EAAA,MAAQ;AAEpB,SAASC,iBAAA,IAAqBC,oBAAoB,QAAQ;AAC1D,SAASC,SAAA,IAAaC,YAAY,QAAQ;AAE1C,OAAO,MAAMC,oBAAA,GAAuBA,CAAC;EACnCC,EAAE;EACFC,GAAG;EACHC,cAAc;EACdC,UAAU;EACVC,IAAI;EACJC,MAAM;EACNC,WAAW;EACXC,SAAS;EACTC,iBAAiB;EACjBC,uBAAuB;EACvBC;AAAoB,CAerB,KACCjB,KAAA,CAAMkB,WAAW,CACf,MAAOC,IAAA;EACL,MAAMC,MAAA,GAAS;IACbR,MAAA,EAAQA,MAAA,IAAUS;EACpB;EAEA,MAAMC,OAAA,GAAUH,IAAA,EAAMZ,EAAA,IAAMA,EAAA;EAC5B,MAAMgB,YAAA,GAAelB,YAAA,CAAa;IAChCE,EAAA,EAAIe,OAAA;IACJb,cAAA;IACAC;EACF;EAEA,IAAIa,YAAA,EAAc;IAChB,MAAMC,YAAA,GAAef,cAAA,GACjB,IAAIA,cAAA,WAAyBa,OAAA,EAAS,GACtCZ,UAAA,GACE,YAAYA,UAAA,SAAmB,GAC/B;IAEN,IAAIc,YAAA,EAAc;MAChB,MAAMC,GAAA,GAAM,MAAMC,KAAA,CAChB,GAAGZ,SAAA,GAAYN,GAAA,GAAMgB,YAAA,IAAgBvB,EAAA,CAAG0B,SAAS,CAACP,MAAA,GAAS,EAC3D;QACEQ,IAAA,EAAMC,IAAA,CAAKF,SAAS,CAAC;UACnB,IAAIR,IAAA,IAAQ,CAAC,CAAC;UACdW,OAAA,EAAS;QACX;QACAC,WAAA,EAAa;QACbC,OAAA,EAAS;UACP,mBAAmBrB,IAAA,CAAKsB,QAAQ;UAChC,gBAAgB;QAClB;QACAC,MAAA,EAAQ;MACV;MAGF,MAAMC,IAAA,GAAqC,MAAMV,GAAA,CAAIU,IAAI;MAEzD,MAAMC,mBAAA,GAAsB,MAAMV,KAAA,CAChC,GAAGZ,SAAA,GAAYN,GAAA,GAAMgB,YAAA,IAAgBvB,EAAA,CAAG0B,SAAS,CAACP,MAAA,GAAS,EAC3D;QACEQ,IAAA,EAAMC,IAAA,CAAKF,SAAS,CAAC;UACnB,IAAIR,IAAA,IAAQ,CAAC,CAAC;UACdW,OAAA,EAAS;QACX;QACAC,WAAA,EAAa;QACbC,OAAA,EAAS;UACP,mBAAmBrB,IAAA,CAAKsB,QAAQ;UAChC,gBAAgB;QAClB;QACAC,MAAA,EAAQ;MACV,GACAG,IAAI,CAAEZ,GAAA,IAAQA,GAAA,CAAIU,IAAI;MAExBpB,iBAAA,CAAkBoB,IAAA;MAElBlB,oBAAA,CACEd,oBAAA,CAAqB;QACnBM,cAAA;QACA6B,cAAA,EAAgBH,IAAA;QAChBzB,UAAA;QACAN,SAAA,EAAWmB;MACb;MAGFP,uBAAA,CAAwBoB,mBAAA,EAAqBG,MAAA;IAC/C;EACF,OAAO;IACL;IACA;IACA,MAAMC,iBAAA,GAAoB/B,cAAA,GACtBI,WAAA,EAAa4B,WAAA,GAAchC,cAAA,CAAe,GAC1CI,WAAA,EAAa6B,OAAA,GAAUhC,UAAA,CAAW;IAEtCK,iBAAA,CAAkByB,iBAAA;IAElBvB,oBAAA,CACEd,oBAAA,CAAqB;MACnBM,cAAA;MACA6B,cAAA,EAAgBE,iBAAA;MAChB9B,UAAA;MACAN,SAAA,EAAWmB;IACb;EAEJ;AACF,GACA,CACET,SAAA,EACAN,GAAA,EACAD,EAAA,EACAM,WAAA,EACAF,IAAA,CAAKsB,QAAQ,EACbrB,MAAA,EACAH,cAAA,EACAC,UAAA,CACD","ignoreList":[]}