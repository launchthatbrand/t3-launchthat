{"version":3,"file":"index.js","names":["React","useCallback","useEffect","useMemo","useRef","useState","useRouter","useSearchParams","isNumber","transformColumnsToSearchParams","qs","useListDrawerContext","useEffectEvent","useRouteTransition","parseSearchParams","ListQueryContext","ListQueryModifiedContext","useListQuery","ListQueryProvider","children","collectionSlug","columns","data","defaultLimit","defaultSort","listPreferences","modifySearchParams","onQueryChange","onQueryChangeFromProps","orderableFieldName","router","rawSearchParams","startRouteTransition","modified","setModified","searchParams","contextRef","current","currentQuery","setCurrentQuery","refineListData","incomingQuery","undefined","page","newQuery","limit","String","preset","search","sort","where","replace","stringify","JSON","addQueryPrefix","onChangeFn","handlePageChange","arg","handlePerPageChange","handleSearchChange","handleSortChange","handleWhereChange","syncQuery","shouldUpdateQueryString","window","history","replaceState","_jsx","value","query"],"sources":["../../../src/providers/ListQuery/index.tsx"],"sourcesContent":["\"use client\";\n\nimport React, {\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from \"react\";\nimport { useRouter, useSearchParams } from \"next/navigation.js\";\nimport { type ListQuery, type Where } from \"@convexcms/core\";\nimport {\n  isNumber,\n  transformColumnsToSearchParams,\n} from \"@convexcms/core/shared\";\nimport * as qs from \"qs-esm\";\n\nimport type { IListQueryContext, ListQueryProps } from \"./types.js\";\nimport { useListDrawerContext } from \"../../elements/ListDrawer/Provider.js\";\nimport { useEffectEvent } from \"../../hooks/useEffectEvent.js\";\nimport { useRouteTransition } from \"../../providers/RouteTransition/index.js\";\nimport { parseSearchParams } from \"../../utilities/parseSearchParams.js\";\nimport { ListQueryContext, ListQueryModifiedContext } from \"./context.js\";\n\nexport { useListQuery } from \"./context.js\";\n\nexport const ListQueryProvider: React.FC<ListQueryProps> = ({\n  children,\n  collectionSlug,\n  columns,\n  data,\n  defaultLimit,\n  defaultSort,\n  listPreferences,\n  modifySearchParams,\n  onQueryChange: onQueryChangeFromProps,\n  orderableFieldName,\n}) => {\n  \"use no memo\";\n  const router = useRouter();\n  const rawSearchParams = useSearchParams();\n  const { startRouteTransition } = useRouteTransition();\n  const [modified, setModified] = useState(false);\n\n  const searchParams = useMemo<ListQuery>(\n    () => parseSearchParams(rawSearchParams),\n    [rawSearchParams],\n  );\n\n  const contextRef = useRef({} as IListQueryContext);\n\n  contextRef.current.modified = modified;\n\n  const { onQueryChange } = useListDrawerContext();\n\n  const [currentQuery, setCurrentQuery] = useState<ListQuery>(() => {\n    if (modifySearchParams) {\n      return searchParams;\n    } else {\n      return {};\n    }\n  });\n\n  const refineListData = useCallback(\n    // eslint-disable-next-line @typescript-eslint/require-await\n    async (incomingQuery: ListQuery, modified?: boolean) => {\n      if (modified !== undefined) {\n        setModified(modified);\n      } else {\n        setModified(true);\n      }\n\n      let page =\n        \"page\" in incomingQuery ? incomingQuery.page : currentQuery?.page;\n\n      if (\"where\" in incomingQuery || \"search\" in incomingQuery) {\n        page = \"1\";\n      }\n\n      const newQuery: ListQuery = {\n        columns:\n          \"columns\" in incomingQuery\n            ? incomingQuery.columns\n            : currentQuery.columns,\n        limit:\n          \"limit\" in incomingQuery\n            ? incomingQuery.limit\n            : (currentQuery?.limit ?? String(defaultLimit)),\n        page,\n        preset:\n          \"preset\" in incomingQuery\n            ? incomingQuery.preset\n            : currentQuery?.preset,\n        search:\n          \"search\" in incomingQuery\n            ? incomingQuery.search\n            : currentQuery?.search,\n        sort:\n          \"sort\" in incomingQuery\n            ? incomingQuery.sort\n            : ((currentQuery?.sort as string) ?? defaultSort),\n        where:\n          \"where\" in incomingQuery ? incomingQuery.where : currentQuery?.where,\n      };\n\n      if (modifySearchParams) {\n        startRouteTransition(() =>\n          router.replace(\n            `${qs.stringify(\n              { ...newQuery, columns: JSON.stringify(newQuery.columns) },\n              { addQueryPrefix: true },\n            )}`,\n          ),\n        );\n      } else if (\n        typeof onQueryChange === \"function\" ||\n        typeof onQueryChangeFromProps === \"function\"\n      ) {\n        const onChangeFn = onQueryChange || onQueryChangeFromProps;\n        onChangeFn(newQuery);\n      }\n\n      setCurrentQuery(newQuery);\n    },\n    [\n      currentQuery?.columns,\n      currentQuery?.limit,\n      currentQuery?.page,\n      currentQuery?.search,\n      currentQuery?.sort,\n      currentQuery?.where,\n      currentQuery?.preset,\n      startRouteTransition,\n      defaultLimit,\n      defaultSort,\n      modifySearchParams,\n      onQueryChange,\n      onQueryChangeFromProps,\n      router,\n    ],\n  );\n\n  const handlePageChange = useCallback(\n    async (arg: number) => {\n      await refineListData({ page: String(arg) });\n    },\n    [refineListData],\n  );\n\n  const handlePerPageChange = React.useCallback(\n    async (arg: number) => {\n      await refineListData({ limit: String(arg), page: \"1\" });\n    },\n    [refineListData],\n  );\n\n  const handleSearchChange = useCallback(\n    async (arg: string) => {\n      const search = arg === \"\" ? undefined : arg;\n      await refineListData({ search });\n    },\n    [refineListData],\n  );\n\n  const handleSortChange = useCallback(\n    async (arg: string) => {\n      await refineListData({ sort: arg });\n    },\n    [refineListData],\n  );\n\n  const handleWhereChange = useCallback(\n    async (arg: Where) => {\n      await refineListData({ where: arg });\n    },\n    [refineListData],\n  );\n\n  const syncQuery = useEffectEvent(() => {\n    let shouldUpdateQueryString = false;\n    const newQuery = { ...(currentQuery || {}) };\n\n    // Allow the URL to override the default limit\n    if (isNumber(defaultLimit) && !(\"limit\" in currentQuery)) {\n      newQuery.limit = String(defaultLimit);\n      shouldUpdateQueryString = true;\n    }\n\n    // Allow the URL to override the default sort\n    if (defaultSort && !(\"sort\" in currentQuery)) {\n      newQuery.sort = defaultSort;\n      shouldUpdateQueryString = true;\n    }\n\n    // Only modify columns if they originated from preferences\n    // We can assume they did if `listPreferences.columns` is defined\n    if (columns && listPreferences?.columns && !(\"columns\" in currentQuery)) {\n      newQuery.columns = transformColumnsToSearchParams(columns);\n      shouldUpdateQueryString = true;\n    }\n\n    if (shouldUpdateQueryString) {\n      setCurrentQuery(newQuery);\n      // Do not use router.replace here to avoid re-rendering on initial load\n      window.history.replaceState(\n        null,\n        \"\",\n        `?${qs.stringify({ ...newQuery, columns: JSON.stringify(newQuery.columns) })}`,\n      );\n    }\n  });\n\n  // If `defaultLimit` or `defaultSort` are updated externally, update the query\n  // I.e. when HMR runs, these properties may be different\n  useEffect(() => {\n    if (modifySearchParams) {\n      syncQuery();\n    }\n  }, [defaultSort, defaultLimit, modifySearchParams, columns]);\n\n  return (\n    <ListQueryContext\n      value={{\n        collectionSlug,\n        data,\n        handlePageChange,\n        handlePerPageChange,\n        handleSearchChange,\n        handleSortChange,\n        handleWhereChange,\n        orderableFieldName,\n        query: currentQuery,\n        refineListData,\n        setModified,\n        ...contextRef.current,\n      }}\n    >\n      <ListQueryModifiedContext value={modified}>\n        {children}\n      </ListQueryModifiedContext>\n    </ListQueryContext>\n  );\n};\n"],"mappings":"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","ignoreList":[]}