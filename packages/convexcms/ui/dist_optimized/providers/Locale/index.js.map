{"version":3,"file":"index.js","names":["React","createContext","use","useEffect","useRef","useState","useSearchParams","findLocaleFromCode","useAuth","useConfig","usePreferences","LocaleContext","LocaleLoadingContext","localeIsLoading","setLocaleIsLoading","_","undefined","fetchPreferences","key","baseURL","fetch","credentials","headers","method","then","res","json","LocaleProvider","children","locale","initialLocaleFromPrefs","config","localization","routes","api","apiRoute","serverURL","user","defaultLocale","getPreference","setPreference","localeFromParams","get","setLocale","locales","length","code","isLoading","prevLocale","current","fetchURL","resetLocale","id","localeToUse","value","newLocale","_jsx","useLocaleLoading","useLocale"],"sources":["../../../src/providers/Locale/index.tsx"],"sourcesContent":["\"use client\";\n\nimport type { Locale } from \"@convexcms/core\";\nimport React, { createContext, use, useEffect, useRef, useState } from \"react\";\nimport { useSearchParams } from \"next/navigation.js\";\n\nimport { findLocaleFromCode } from \"../../utilities/findLocaleFromCode.js\";\nimport { useAuth } from \"../Auth/index.js\";\nimport { useConfig } from \"../Config/index.js\";\nimport { usePreferences } from \"../Preferences/index.js\";\n\nconst LocaleContext = createContext({} as Locale);\n\nexport const LocaleLoadingContext = createContext({\n  localeIsLoading: false,\n  setLocaleIsLoading: (_: boolean) => undefined,\n});\n\nconst fetchPreferences = async <T extends Record<string, unknown> | string>(\n  key: string,\n  baseURL: string,\n): Promise<{ id: string; value: T }> =>\n  await fetch(`${baseURL}/payload-preferences/${key}`, {\n    credentials: \"include\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    method: \"GET\",\n  })?.then((res) => res.json() as Promise<{ id: string; value: T }>);\n\nexport const LocaleProvider: React.FC<{\n  children?: React.ReactNode;\n  locale?: Locale[\"code\"];\n}> = ({\n  children,\n  /**\n    The `locale` prop originates from the root layout, which does not have access to search params\n    This component uses the `useSearchParams` hook to get the locale from the URL as precedence over this prop\n    This prop does not update as the user navigates the site, because the root layout does not re-render\n  */\n  locale: initialLocaleFromPrefs,\n}) => {\n  const {\n    config: {\n      localization = false,\n      routes: { api: apiRoute },\n      serverURL,\n    },\n  } = useConfig();\n\n  const { user } = useAuth();\n\n  const defaultLocale = localization ? localization.defaultLocale : \"en\";\n\n  const { getPreference, setPreference } = usePreferences();\n  const localeFromParams = useSearchParams().get(\"locale\");\n\n  const [locale, setLocale] = React.useState<Locale>(() => {\n    if (!localization || (localization && !localization.locales.length)) {\n      // TODO: return null V4\n      return {} as Locale;\n    }\n\n    return (\n      findLocaleFromCode(localization, localeFromParams) ||\n      findLocaleFromCode(localization, initialLocaleFromPrefs) ||\n      findLocaleFromCode(localization, defaultLocale) ||\n      findLocaleFromCode(localization, localization.locales[0].code)\n    );\n  });\n\n  const [isLoading, setLocaleIsLoading] = useState(false);\n\n  const prevLocale = useRef<Locale>(locale);\n\n  useEffect(() => {\n    /**\n     * We need to set `isLoading` back to false once the locale is detected to be different\n     * This happens when the user clicks an anchor link which appends the `?locale=` query param\n     * This triggers a client-side navigation, which re-renders the page with the new locale\n     * In Next.js, local state is persisted during this type of navigation because components are not unmounted\n     */\n    if (locale.code !== prevLocale.current.code) {\n      setLocaleIsLoading(false);\n    }\n\n    prevLocale.current = locale;\n  }, [locale]);\n\n  const fetchURL = `${serverURL}${apiRoute}`;\n\n  useEffect(() => {\n    /**\n     * This effect should only run when `localeFromParams` changes, i.e. when the user clicks an anchor link\n     * The root layout, which sends the initial locale from prefs, will not re-render as the user navigates the site\n     * For this reason, we need to fetch the locale from prefs if the search params clears the `locale` query param\n     */\n    async function resetLocale() {\n      if (localization && user?.id) {\n        const localeToUse =\n          localeFromParams ||\n          (await fetchPreferences<Locale[\"code\"]>(\"locale\", fetchURL)?.then(\n            (res) => res.value,\n          ));\n\n        const newLocale =\n          findLocaleFromCode(localization, localeToUse) ||\n          findLocaleFromCode(localization, defaultLocale) ||\n          findLocaleFromCode(localization, localization?.locales?.[0]?.code);\n\n        if (newLocale) {\n          setLocale(newLocale);\n        }\n      }\n    }\n\n    void resetLocale();\n  }, [\n    defaultLocale,\n    getPreference,\n    localization,\n    fetchURL,\n    localeFromParams,\n    user?.id,\n  ]);\n\n  return (\n    <LocaleContext value={locale}>\n      <LocaleLoadingContext\n        value={{ localeIsLoading: isLoading, setLocaleIsLoading }}\n      >\n        {children}\n      </LocaleLoadingContext>\n    </LocaleContext>\n  );\n};\n\nexport const useLocaleLoading = () => use(LocaleLoadingContext);\n\n/**\n * TODO: V4\n * The return type of the `useLocale` hook will change in v4. It will return `null | Locale` instead of `false | {} | Locale`.\n */\nexport const useLocale = (): Locale => use(LocaleContext);\n"],"mappings":"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","ignoreList":[]}