{"version":3,"file":"useHotkey.js","names":["useCallback","useEffect","setsAreEqual","useModal","pressedKeys","Map","map","altleft","altright","controlleft","controlright","ctrlleft","ctrlright","escape","metaleft","metaright","osleft","osright","shiftleft","shiftright","stripKey","key","toLowerCase","trim","replace","pushToKeys","code","forEach","time","pressedKey","delete","set","Date","now","removeFromKeys","clear","useHotkey","options","func","cmdCtrlKey","editDepth","keyCodes","modalState","keydown","event","e","detail","undefined","hasCmd","window","navigator","userAgent","includes","pressedWithoutModifier","keys","filter","Set","has","ctrlKey","maxEditDepth","Object","isOpen","length","keyup","document","addEventListener","removeEventListener"],"sources":["../../src/hooks/useHotkey.ts"],"sourcesContent":["\"use client\";\n\nimport { useCallback, useEffect } from \"react\";\nimport { setsAreEqual } from \"@convexcms/core/shared\";\nimport { useModal } from \"@faceless-ui/modal\";\n\n// Required to be outside of hook, else debounce would be necessary\n// and then one could not prevent the default behaviour.\n\n// It maps the pressed keys with the time they were pressed, in order to implement a maximum time\n// for the user to press the next key in the sequence\n\n// This is necessary to prevent a bug where the keyup event, which unsets the key as pressed\n// is not fired when the window is not focused.\n// When the user then comes back to the window, the key is still registered as pressed, even though it's not.\nconst pressedKeys = new Map<string, number>([]);\n\nconst map = {\n  altleft: \"alt\",\n  altright: \"alt\",\n  controlleft: \"ctrl\",\n  controlright: \"ctrl\",\n  ctrlleft: \"ctrl\",\n  ctrlright: \"ctrl\",\n  escape: \"esc\",\n  metaleft: \"meta\",\n  metaright: \"meta\",\n  osleft: \"meta\",\n  osright: \"meta\",\n  shiftleft: \"shift\",\n  shiftright: \"shift\",\n};\n\nconst stripKey = (key: string) => {\n  return (map[key.toLowerCase()] || key)\n    .trim()\n    .toLowerCase()\n    .replace(\"key\", \"\");\n};\n\nconst pushToKeys = (code: string) => {\n  const key = stripKey(code);\n\n  // There is a weird bug with macos that if the keys are not cleared they remain in the\n  // pressed keys set.\n  if (key === \"meta\") {\n    pressedKeys.forEach(\n      (time, pressedKey) =>\n        pressedKey !== \"meta\" && pressedKeys.delete(pressedKey),\n    );\n  }\n\n  pressedKeys.set(key, Date.now());\n};\n\nconst removeFromKeys = (code: string) => {\n  const key = stripKey(code);\n  // There is a weird bug with macos that if the keys are not cleared they remain in the\n  // pressed keys set.\n  if (key === \"meta\") {\n    pressedKeys.clear();\n  }\n  pressedKeys.delete(key);\n};\n\n/**\n * Hook function to work with hotkeys.\n * @param param0.keyCode {string[]} The keys to listen for (`Event.code` without `'Key'` and lowercased)\n * @param param0.cmdCtrlKey {boolean} Whether Ctrl on windows or Cmd on mac must be pressed\n * @param param0.editDepth {boolean} This ensures that the hotkey is only triggered for the most top-level drawer in case there are nested drawers\n * @param func The callback function\n */\nexport const useHotkey = (\n  options: {\n    cmdCtrlKey: boolean;\n    editDepth: number;\n    keyCodes: string[];\n  },\n  func: (e: KeyboardEvent) => void,\n): void => {\n  const { cmdCtrlKey, editDepth, keyCodes } = options;\n\n  const { modalState } = useModal();\n\n  const keydown = useCallback(\n    (event: CustomEvent | KeyboardEvent) => {\n      const e: KeyboardEvent = event.detail?.key ? event.detail : event;\n      if (e.key === undefined) {\n        // Autofill events, or other synthetic events, can be ignored\n        return;\n      }\n\n      // Filter out pressed keys which have been pressed > 3 seconds ago\n      pressedKeys.forEach((time, key) => {\n        if (Date.now() - time > 3000) {\n          pressedKeys.delete(key);\n        }\n      });\n\n      if (e.code) {\n        pushToKeys(e.code);\n      }\n\n      // Check for Mac and iPad\n      const hasCmd = window.navigator.userAgent.includes(\"Mac OS X\");\n      const pressedWithoutModifier = [...pressedKeys.keys()].filter(\n        (key) => ![\"alt\", \"ctrl\", \"meta\", \"shift\"].includes(key),\n      );\n\n      // Check whether arrays contain the same values (regardless of number of occurrences)\n      if (\n        setsAreEqual(new Set(pressedWithoutModifier), new Set(keyCodes)) &&\n        (!cmdCtrlKey ||\n          (hasCmd && pressedKeys.has(\"meta\")) ||\n          (!hasCmd && e.ctrlKey))\n      ) {\n        // get the maximum edit depth by counting the number of open drawers. modalState is and object which contains the state of all drawers.\n        const maxEditDepth =\n          Object.keys(modalState).filter((key) => modalState[key]?.isOpen)\n            ?.length + 1 || 1;\n\n        if (maxEditDepth !== editDepth) {\n          // We only want to execute the hotkey from the most top-level drawer / edit depth.\n          return;\n        }\n        // execute the function associated with the maximum edit depth\n        func(e);\n      }\n    },\n    [keyCodes, cmdCtrlKey, editDepth, modalState, func],\n  );\n\n  const keyup = useCallback((e: KeyboardEvent) => {\n    if (e.code) {\n      removeFromKeys(e.code);\n    }\n  }, []);\n\n  useEffect(() => {\n    document.addEventListener(\"keydown\", keydown, false);\n    document.addEventListener(\"bypassKeyDown\", keydown, false); // this is called if the keydown event's propagation is stopped by react-select\n    document.addEventListener(\"keyup\", keyup, false);\n\n    return () => {\n      document.removeEventListener(\"keydown\", keydown);\n      document.removeEventListener(\"bypassKeyDown\", keydown);\n      document.removeEventListener(\"keyup\", keyup);\n    };\n  }, [keydown, keyup]);\n};\n"],"mappings":"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","ignoreList":[]}