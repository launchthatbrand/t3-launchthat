import type { PNG } from "pngjs";
import type { Rgba, TextAlign } from "../types";
import { fillRect } from "../png/primitives";

// Minimal bitmap font (5x7) as last-resort fallback when canvas is unavailable.
const FONT_5x7: Record<string, string[]> = {
  // Letters (uppercase)
  A: ["01110", "10001", "10001", "11111", "10001", "10001", "10001"],
  B: ["11110", "10001", "10001", "11110", "10001", "10001", "11110"],
  C: ["01110", "10001", "10000", "10000", "10000", "10001", "01110"],
  D: ["11110", "10001", "10001", "10001", "10001", "10001", "11110"],
  E: ["11111", "10000", "10000", "11110", "10000", "10000", "11111"],
  F: ["11111", "10000", "10000", "11110", "10000", "10000", "10000"],
  G: ["01110", "10001", "10000", "10111", "10001", "10001", "01110"],
  H: ["10001", "10001", "10001", "11111", "10001", "10001", "10001"],
  I: ["01110", "00100", "00100", "00100", "00100", "00100", "01110"],
  J: ["00111", "00010", "00010", "00010", "00010", "10010", "01100"],
  K: ["10001", "10010", "10100", "11000", "10100", "10010", "10001"],
  L: ["10000", "10000", "10000", "10000", "10000", "10000", "11111"],
  M: ["10001", "11011", "10101", "10101", "10001", "10001", "10001"],
  N: ["10001", "11001", "10101", "10011", "10001", "10001", "10001"],
  O: ["01110", "10001", "10001", "10001", "10001", "10001", "01110"],
  P: ["11110", "10001", "10001", "11110", "10000", "10000", "10000"],
  Q: ["01110", "10001", "10001", "10001", "10101", "10010", "01101"],
  R: ["11110", "10001", "10001", "11110", "10100", "10010", "10001"],
  S: ["01111", "10000", "10000", "01110", "00001", "00001", "11110"],
  T: ["11111", "00100", "00100", "00100", "00100", "00100", "00100"],
  U: ["10001", "10001", "10001", "10001", "10001", "10001", "01110"],
  V: ["10001", "10001", "10001", "10001", "10001", "01010", "00100"],
  W: ["10001", "10001", "10001", "10101", "10101", "10101", "01010"],
  X: ["10001", "10001", "01010", "00100", "01010", "10001", "10001"],
  Y: ["10001", "10001", "01010", "00100", "00100", "00100", "00100"],
  Z: ["11111", "00001", "00010", "00100", "01000", "10000", "11111"],

  "0": ["01110", "10001", "10001", "10001", "10001", "10001", "01110"],
  "1": ["00100", "01100", "00100", "00100", "00100", "00100", "01110"],
  "2": ["01110", "10001", "00001", "00010", "00100", "01000", "11111"],
  "3": ["01110", "10001", "00001", "00110", "00001", "10001", "01110"],
  "4": ["00010", "00110", "01010", "10010", "11111", "00010", "00010"],
  "5": ["11111", "10000", "11110", "00001", "00001", "10001", "01110"],
  "6": ["00110", "01000", "10000", "11110", "10001", "10001", "01110"],
  "7": ["11111", "00001", "00010", "00100", "01000", "01000", "01000"],
  "8": ["01110", "10001", "10001", "01110", "10001", "10001", "01110"],
  "9": ["01110", "10001", "10001", "01111", "00001", "00010", "01100"],
  ".": ["00000", "00000", "00000", "00000", "00000", "00110", "00110"],
  "-": ["00000", "00000", "00000", "11111", "00000", "00000", "00000"],
  "/": ["00001", "00010", "00100", "01000", "10000", "00000", "00000"],
  ":": ["00000", "00110", "00110", "00000", "00110", "00110", "00000"],
  " ": ["00000", "00000", "00000", "00000", "00000", "00000", "00000"],
};

const BLANK_GLYPH = ["00000", "00000", "00000", "00000", "00000", "00000", "00000"];

export const drawChar5x7 = (img: PNG, ch: string, x: number, y: number, scale: number, rgba: Rgba) => {
  const glyph = FONT_5x7[ch] ?? BLANK_GLYPH;
  const s = Math.max(1, Math.floor(scale));
  for (let row = 0; row < glyph.length; row++) {
    const line = glyph[row] ?? "";
    for (let col = 0; col < line.length; col++) {
      if (line.charAt(col) !== "1") continue;
      fillRect(img, x + col * s, y + row * s, s, s, rgba);
    }
  }
};

export const drawText5x7 = (args: {
  img: PNG;
  text: string;
  x: number;
  y: number;
  scale: number;
  rgba: Rgba;
  align?: TextAlign;
}) => {
  const { img, text, y, scale, rgba } = args;
  const s = Math.max(1, Math.floor(scale));
  const charW = 5 * s;
  const gap = 1 * s;
  const width = text.length > 0 ? text.length * charW + (text.length - 1) * gap : 0;
  const xStart = args.align === "right" ? Math.round(args.x - width) : Math.round(args.x);
  let x = xStart;
  for (const ch of text) {
    drawChar5x7(img, ch, x, Math.round(y), s, rgba);
    x += charW + gap;
  }
};

