# Task ID: 14
# Title: Implement Contacts/CRM System - Core Functionality
# Status: done
# Dependencies: 1, 2
# Priority: medium
# Description: Develop the core contacts management system with comprehensive user information and custom fields.
# Details:
Implement the following features for the contacts/CRM system:
1. Contact profiles with standard and custom fields
2. Contact grouping and tagging
3. Contact search and filtering
4. Import/export functionality

API endpoints to implement:
- `createContact(userId, contactData)`
- `updateContact(contactId, updates)`
- `deleteContact(contactId)`
- `getContacts(userId, filters, search, pagination)`
- `getContact(contactId)`
- `addContactTag(contactId, tag)`
- `removeContactTag(contactId, tag)`
- `importContacts(userId, contacts)`
- `exportContacts(userId, filters)`

UI components to implement:
- ContactsList
- ContactCard
- ContactDetailPage
- ContactForm
- TagManager
- ImportContactsForm
- ExportContactsButton

# Test Strategy:
1. Unit tests for all API endpoints
2. Test contact creation with various field combinations
3. Verify search and filter functionality
4. Test tagging and categorization
5. Validate import/export with different file formats
6. Test custom fields functionality
7. Verify that contacts are properly isolated between users

# Subtasks:
## 1. Backend: Implement Convex Schema and Core Mutations [done]
### Dependencies: None
### Description: Define the Convex schema for contacts with support for custom fields, tags, and groups. Implement core mutations for CRUD operations.
### Details:
1. Create a `contacts.ts` schema file in the Convex schema directory
2. Define the Contact table with required fields (name, email, phone) and support for dynamic custom fields using a JSON object
3. Define Tags and Groups tables with many-to-many relationships to contacts
4. Implement mutations for creating, updating, and deleting contacts
5. Implement mutations for managing tags and groups
6. Add validation logic for required fields and data formats
7. Implement soft delete functionality for contacts
<info added on 2025-05-26T19:58:49.401Z>
# Implementation Plan for Backend: Convex Schema and Core Mutations

## Files to be created/modified:
- apps/portal/convex/contacts.ts (new)
- apps/portal/convex/schema.ts (update to register new tables)

## Steps:
1. **Create `contacts.ts` in Convex**
   - Define a Contact table with fields: name (string), email (string), phone (string), userId (string), customFields (record or JSON object), tags (array of tag IDs), groups (array of group IDs), createdAt, updatedAt, deletedAt (nullable for soft delete).
   - Define a Tag table: name (string), userId (string), color (string, optional).
   - Define a Group table: name (string), userId (string), description (string, optional).
2. **Update `schema.ts`**
   - Register the new tables and their indexes (e.g., by userId, by tag, by group).
3. **Implement core mutations in `contacts.ts`**
   - createContact(userId, contactData): validate required fields, insert contact.
   - updateContact(contactId, updates): validate, patch contact.
   - deleteContact(contactId): soft delete (set deletedAt).
   - createTag(userId, name, color): insert tag.
   - updateTag(tagId, updates): patch tag.
   - deleteTag(tagId): delete tag.
   - createGroup(userId, name, description): insert group.
   - updateGroup(groupId, updates): patch group.
   - deleteGroup(groupId): delete group.
   - addContactTag(contactId, tagId): add tagId to contact.tags.
   - removeContactTag(contactId, tagId): remove tagId from contact.tags.
   - addContactGroup(contactId, groupId): add groupId to contact.groups.
   - removeContactGroup(contactId, groupId): remove groupId from contact.groups.
4. **Validation**
   - Use Convex validators for all fields. Validate email format, required fields, and uniqueness where needed.
5. **Soft Delete**
   - Implement soft delete for contacts (set deletedAt, filter out in queries).

## Potential Challenges
- Many-to-many relationships in Convex (use arrays of IDs, ensure referential integrity).
- Custom fields: use a record or JSON object for flexibility.
- Indexing for efficient queries by user, tag, group.

## Next Steps
- Implement the schema and mutations as described above.
- Write unit tests for all mutations.
</info added on 2025-05-26T19:58:49.401Z>

## 2. Backend: Implement Search, Filtering and Import/Export [done]
### Dependencies: 14.1
### Description: Create Convex queries for searching, filtering contacts, and implement import/export functionality.
### Details:
1. Implement paginated queries for listing contacts with sorting options
2. Create search functionality across contact fields (name, email, phone, custom fields)
3. Add filtering by tags, groups, and custom field values
4. Implement a batch import mutation that handles CSV/JSON formats
5. Create an export query that formats contact data for CSV/JSON export
6. Add validation and error handling for import operations
7. Implement duplicate detection during import
<info added on 2025-05-26T20:03:36.396Z>
Implementation Status:
- Completed paginated queries with sorting in getContacts query
- Implemented search functionality using Convex's search index
- Added filtering by tags, lead status, and customer type
- Created importContacts mutation with duplicate detection
- Implemented export query with filtering options

Technical Implementation Details:
- Using cursor-based pagination for efficient data retrieval
- Implemented workaround for Convex's filter limitations on tag filtering
- Leveraging Convex's search index for cross-field searching

Outstanding Issues:
- Need to fix TypeScript linter errors:
  * Type inconsistencies between null and undefined
  * Issues with paginate options and results handling
  * Array filtering with includes() not directly supported in Convex

Next Steps:
- Resolve TypeScript errors
- Add additional test cases for edge conditions
- Document API usage patterns for frontend integration
</info added on 2025-05-26T20:03:36.396Z>

## 4. Frontend: Build UI Components and Pages [done]
### Dependencies: None
### Description: Develop React components and pages for the CRM system using Shadcn UI components.
### Details:
1. Create a contacts list page with pagination, sorting, and filtering
2. Implement a contact detail page with editable fields
3. Build a contact creation form with support for custom fields
4. Develop tag and group management UI components
5. Create an advanced search interface with multiple filter options
6. Implement import/export UI with file upload/download functionality
7. Add a dashboard with contact statistics and recent activity
8. Implement responsive designs for mobile and desktop
9. Add loading states and error handling for all API interactions
<info added on 2025-05-26T20:17:31.789Z>
Update implementation to use Convex APIs directly:
1. Refactor all UI components to use Convex queries and mutations instead of tRPC
2. Implement real-time data synchronization using Convex's reactive queries
3. Connect contact list pagination and filtering directly to Convex queries
4. Wire contact creation and editing forms to Convex mutations
5. Integrate tag and group management with Convex data store
6. Connect advanced search interface to Convex query capabilities
7. Implement import/export functionality using Convex file storage and mutations
8. Update dashboard to use Convex's real-time data for statistics and activity feeds
9. Ensure proper error handling for all direct Convex API interactions
</info added on 2025-05-26T20:17:31.789Z>

