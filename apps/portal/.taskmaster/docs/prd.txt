

### PRD: Unify Store Funnels into Centralized Scenarios with Types and Constraints

Overview
- Replace dedicated ecommerce funnels with a unified scenarios system.
- Introduce scenario types with policy-driven constraints.
- Reuse a single React Flow builder across contexts with type-specific behavior.
- Preserve slug-addressable checkout flows and sessions.

Goals
- Centralize all flow modeling in `scenarios/nodes/nodeConnections`.
- Add `scenarioType` to support special flows like ecommerce checkout.
- Enforce required, non-deletable seeded nodes for checkout flows.
- Provide new checkout runtime APIs replacing funnels.
- Migrate existing funnels to scenarios with zero user-visible regression.

Non-Goals
- Payment provider changes.
- Visual redesign of the flow editor beyond constraints and affordances.
- New product/cart logic beyond current behavior.

Current State
- Store funnels at:
  - `apps/portal/convex/ecommerce/funnels/{schema,queries,mutations}.ts`
  - Tables: `funnels`, `funnelSteps`, `funnelEdges`, `funnelSessions`
- Integrations builder at:
  - `apps/portal/convex/integrations/{scenarios,nodes,connections}/...`
  - Tables: `scenarios`, `nodes`, `nodeConnections`
- React Flow builder in `apps/portal/src/app/test/react-flow/*` and funnels admin pages.

High-Level Requirements
- Scenario Types
  - Add `scenarioType` to `scenarios`: `"general" | "checkout"`.
  - For `"checkout"` scenarios, add `slug` (unique), used for public checkout routes.
- Preseeded Nodes for Checkout
  - On create, seed at least 2 nodes: `checkout` and `order_confirmation`, both `isSystem: true` (non-deletable).
  - Default positions reasonable; UI allows repositioning.
- Constraints & Policies
  - Checkout type:
    - Required nodes: at least 1 `checkout` and 1 `order_confirmation`.
    - Allowed node types: `checkout`, `order_confirmation`, `upsell`, `router`, plus safe transforms if needed.
    - Prevent deletion of `isSystem` nodes; prevent updates violating required minimums.
  - General type: no required nodes; no type restriction (existing behavior).
- Node Connections
  - Extend `nodeConnections` to include `label`, `branch`, `order` (funnels parity).
- Runtime Checkout APIs (Scenarios-based)
  - Provide new `checkouts` queries/mutations that mirror funnels runtime behavior and read from scenarios:
    - `getCheckoutBySlug(slug)`
    - `createCheckoutSession({ checkoutSlug, ... })`
    - `updateCheckoutSessionInfo(...)`
    - `completeCheckoutSession(...)`
    - `getCheckoutSession(sessionId)`
    - `setCheckoutSessionItems(sessionId, productIds)`

Data Model Changes (Convex)
- `scenarios` (apps/portal/convex/integrations/schema/scenariosSchema.ts)
  - Add: `scenarioType: "general" | "checkout"`
  - Add: `slug?: string` (unique index `by_slug`) for checkout scenarios
- `nodes` (apps/portal/convex/integrations/schema/nodesSchema.ts)
  - Add: `isSystem?: boolean` (non-deletable when true)
  - Add: `lockedProperties?: string[]` (optional, for future UI locking)
- `nodeConnections` (apps/portal/convex/integrations/schema/nodesSchema.ts)
  - Add: `label?: string`, `branch?: string`, `order?: number`
- Optional: Internal `apps` entries for “Checkout” and “Order Confirmation” (using `apps.isInternal: true`).

APIs (Convex)
- Scenarios
  - `integrations/scenarios/mutations.create`:
    - New args: `scenarioType`, `slug?`
    - If `checkout`: seed `checkout` and `order_confirmation` nodes with `isSystem: true`
  - `integrations/scenarios/queries.list`: add optional `scenarioType` filter
  - `integrations/scenarios/queries.getBySlug(slug)`: checkout-type lookup
  - `integrations/scenarios/mutations.update/remove`: enforce policy checks
- Nodes
  - `integrations/nodes/mutations.create`:
    - Validate `type` allowed for the scenario type
  - `integrations/nodes/mutations.remove`:
    - Block deletion of `isSystem` nodes
    - Enforce required minimums (checkout/order_confirmation)
  - `integrations/nodes/mutations.update`: allow unless violating constraints
- Connections
  - `integrations/nodes/mutations.createConnection/updateConnection`: accept optional `label/branch/order`
- Checkouts (new, scenarios-backed)
  - `ecommerce/checkouts/queries.ts`:
    - `getCheckoutBySlug(slug)` resolves checkout scenario and checkout node config; fetches products
    - `getCheckoutSession(sessionId)`
  - `ecommerce/checkouts/mutations.ts`:
    - `createCheckoutSession`, `updateCheckoutSessionInfo`, `completeCheckoutSession`, `setCheckoutSessionItems`

UI/UX
- Admin
  - Replace funnels admin pages with a “Checkout Scenarios” view using `scenarios` of type `checkout`.
  - “Create Checkout Flow” button calls `scenarios.create({ scenarioType: "checkout", slug, ... })`.
  - React Flow editor reused; hide delete button for `isSystem` nodes; filter palette by allowed types.
- Frontend
  - Replace `api.ecommerce.funnels.*` with new `api.ecommerce.checkouts.*` endpoints.
  - Routes continue to use `slug`.
  - Maintain existing layout flags via checkout node config.

Migration Plan
- Phase 1: Add schema extensions and policies (no behavior change).
- Phase 2: Implement seeding on scenario create; node deletion/creation constraints.
- Phase 3: Implement checkouts runtime APIs; dual-run with funnels.
- Phase 4: Data migration action:
  - funnels → scenarios
  - funnelSteps → nodes (map types: funnelCheckout→checkout; order_confirmation→order_confirmation; landing→landing; upsell→upsell)
  - funnelEdges → nodeConnections (copy label/order/branch)
  - funnelSessions: add `scenarioId` or move to `checkoutSessions`
- Phase 5: Switch UI to scenarios-based checkouts; verify parity.
- Phase 6: Remove funnels code and tables.

Acceptance Criteria
- Creating a checkout scenario seeds `checkout` and `order_confirmation` nodes with `isSystem: true`.
- Deleting a seeded node is blocked in both UI and backend.
- Adding a node of a disallowed type to a checkout scenario is blocked.
- `getCheckoutBySlug` mirrors `getFunnelCheckoutBySlug` response shape.
- Frontend checkout flows work unchanged after switch.
- Admin can list/create/edit checkout scenarios via unified builder.
- Node connections support `label/branch/order`.
- Migration runs without data loss; counts and mapping preserved.

Security & Permissions
- Preserve existing admin/auth checks from funnels.
- Ensure new endpoints match current permission model.

Risks
- Slug collisions during migration.
- Session continuity if switching table names.

Mitigations
- Enforce unique `by_slug`.
- Prefer adding `scenarioId` to existing `funnelSessions` for compatibility before creating new tables. 