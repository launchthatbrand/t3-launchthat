# Task ID: 4
# Title: Implement Real-time Collaborative Features
# Status: pending
# Dependencies: 1, 2, 3
# Priority: medium
# Description: Add real-time collaborative editing capabilities to allow multiple users to work on course structures simultaneously with conflict resolution.
# Details:
1. Implement operational transformation:
   - Use Yjs library for CRDT-based collaboration
   - Integrate Yjs with Convex for persistence

2. Add real-time presence indicators:
   - Implement a PresenceIndicator component
   - Use Convex real-time subscriptions for user presence

3. Create conflict resolution UI:
   - Implement a ConflictResolutionModal component
   - Use diff algorithm to highlight conflicting changes

4. Implement change attribution and activity feeds:
   - Create an ActivityFeed component
   - Store user actions in Convex with timestamps

Example implementation:

```typescript
import * as Y from 'yjs'
import { WebsocketProvider } from 'y-websocket'
import { useConvex } from 'convex/react'
import { useUnifiedCourseState } from './useUnifiedCourseState'

const CollaborativeCourseBuilder = () => {
  const convex = useConvex()
  const { courseStructure, updateStructure } = useUnifiedCourseState()

  useEffect(() => {
    const ydoc = new Y.Doc()
    const provider = new WebsocketProvider('wss://your-server.com', 'course-room', ydoc)
    const yarray = ydoc.getArray('course-structure')

    yarray.observe(event => {
      const newStructure = yarray.toArray()
      updateStructure(newStructure)
      convex.mutation('updateCourseStructure', { structure: newStructure })
    })

    return () => {
      provider.disconnect()
      ydoc.destroy()
    }
  }, [])

  return (
    <div>
      <CourseBuilder structure={courseStructure} />
      <PresenceIndicator />
      <ActivityFeed />
      <ConflictResolutionModal />
    </div>
  )
}
```

Ensure to implement proper error handling and offline support for collaborative features.

# Test Strategy:
1. Multi-user testing:
   - Set up multiple browser instances with Puppeteer
   - Simulate concurrent edits and verify consistency
   - Test various network conditions (latency, packet loss)

2. Conflict scenario testing:
   - Create test cases for common conflict scenarios
   - Verify conflict resolution UI and logic
   - Test edge cases (e.g., conflicting deletes)

3. Network partition testing:
   - Simulate network partitions using Toxiproxy
   - Verify eventual consistency after partition healing
   - Test offline editing and synchronization

4. Performance testing with multiple users:
   - Simulate 50+ concurrent users editing
   - Measure latency and CPU/memory usage
   - Optimize for large-scale collaboration

Use Jest for unit tests, Puppeteer for multi-user simulations, and Toxiproxy for network condition testing. Implement load testing using k6 for simulating many concurrent users.

# Subtasks:
## 1. Implement Yjs Integration [pending]
### Dependencies: None
### Description: Integrate Yjs library with the existing course structure for CRDT-based collaboration
### Details:
Set up Yjs document, integrate WebsocketProvider, and create shared data types for course structure. Implement synchronization between Yjs and local state.

## 2. Develop Real-time Presence Indicators [pending]
### Dependencies: 4.1
### Description: Create a PresenceIndicator component to show active users in the collaborative session
### Details:
Implement user presence tracking using Convex real-time subscriptions. Design and create a UI component to display active users with their current editing positions.

## 3. Implement Conflict Resolution UI [pending]
### Dependencies: 4.1
### Description: Create a ConflictResolutionModal component to handle and resolve editing conflicts
### Details:
Develop a diff algorithm to detect conflicts. Design and implement a modal UI for displaying conflicting changes and allowing users to choose which changes to keep.

## 4. Create Activity Feed Component [pending]
### Dependencies: 4.1, 4.2
### Description: Develop an ActivityFeed component to display recent changes and user actions
### Details:
Implement a system to track and store user actions with timestamps in Convex. Create a UI component to display the activity feed with real-time updates.

## 5. Implement Offline Support [pending]
### Dependencies: 4.1, 4.3
### Description: Add offline capabilities to allow users to continue working without an internet connection
### Details:
Implement local storage for offline edits. Develop a synchronization mechanism to reconcile offline changes with the server when the connection is restored.

## 6. Optimize Performance and Error Handling [pending]
### Dependencies: 4.1, 4.2, 4.3, 4.4, 4.5
### Description: Improve the overall performance of the collaborative features and implement robust error handling
### Details:
Optimize Yjs operations for large documents. Implement debouncing and throttling for real-time updates. Add comprehensive error handling for network issues, conflicts, and synchronization failures.

